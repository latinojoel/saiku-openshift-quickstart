var Settings={VERSION:"Saiku 2.6-SNAPSHOT",BIPLUGIN:false,BIPLUGIN5:false,BASE_URL:"",TOMCAT_WEBAPP:"/saiku",REST_MOUNT_POINT:"/rest/saiku/",DIMENSION_PREFETCH:true,ERROR_LOGGING:false,ERROR_TOLERANCE:3,QUERY_PROPERTIES:{"saiku.olap.query.automatic_execution":"true","saiku.olap.query.nonempty":"true","saiku.olap.query.nonempty.rows":"true","saiku.olap.query.nonempty.columns":"true","saiku.ui.render.mode":"table"},CELLSET_FORMATTER:"flattened",RESULT_LIMIT:0,MEMBERS_FROM_RESULT:true,MEMBERS_LIMIT:3000,MEMBERS_SEARCH_LIMIT:75,ALLOW_IMPORT_EXPORT:false,PLUGINS:["Chart"],DEFAULT_VIEW_STATE:"view",DEMO:false,TELEMETRY_SERVER:"http://telemetry.analytical-labs.com:7000",LOCALSTORAGE_EXPIRATION:10*60*60*1000};Settings.GET=function(){var a=document.location.search;a=a.split("+").join(" ");var e={},d,b=/[?&]?([^=]+)=([^&]*)/g;while(d=b.exec(a)){var c=decodeURIComponent(d[2]);if(!isNaN(c)){c=parseInt(c)}if(c==="true"){c=true}if(c==="false"){c=false}e[decodeURIComponent(d[1]).toUpperCase()]=c}return e}();_.extend(Settings,Settings.GET);Settings.PARAMS=(function(){var b={};for(var a in Settings){if(a.match("^PARAM")=="PARAM"){b[a]=Settings[a]}}return b}());Settings.REST_URL=Settings.BASE_URL+Settings.TOMCAT_WEBAPP+Settings.REST_MOUNT_POINT;if(Settings.MODE=="table"){Settings.DIMENSION_PREFETCH=false;$("body, html").css("min-height",0);$("body, html").css("min-width",0)}if(Settings.BIPLUGIN5){Settings.BIPLUGIN=true}Settings.INITIAL_QUERY=false;if(document.location.hash){var hash=document.location.hash;if(hash.length>11&&hash.substring(1,11)=="query/open"){Settings.INITIAL_QUERY=true}}if(!Array.prototype.indexOf){Array.prototype.indexOf=function(b){var a=this.length>>>0;var c=Number(arguments[1])||0;c=(c<0)?Math.ceil(c):Math.floor(c);if(c<0){c+=a}for(;c<a;c++){if(c in this&&this[c]===b){return c}}return -1}}var tagsToReplace={"&":"&amp;","<":"&lt;",">":"&gt;"};function replaceTag(a){return tagsToReplace[a]||a}function safe_tags_replace(a){return a.replace(/[&<>]/g,replaceTag)}if($.blockUI){$.blockUI.defaults.css={};$.blockUI.defaults.overlayCSS={};$.blockUI.defaults.blockMsgClass="processing";$.blockUI.defaults.fadeOut=0;$.blockUI.defaults.fadeIn=0;$.blockUI.defaults.ignoreIfBlocked=false}if(window.location.hostname&&(window.location.hostname=="dev.analytical-labs.com"||window.location.hostname=="demo.analytical-labs.com")){Settings.USERNAME="admin";Settings.PASSWORD="admin";Settings.DEMO=true}var isIE=(function(){var c,a=3;var b=navigator.appVersion;if(b.indexOf("MSIE")!=-1){a=parseFloat(b.split("MSIE ")[1]);return a>4?a:false}return false}());var SaikuRendererOptions={mode:null,dataMode:null,htmlObject:null,width:null,height:null};var SaikuRenderer=function(b,a){this._options=_.extend(SaikuRendererOptions,a);this._hasProcessed=false;if(Backbone){_.extend(this,Backbone.Events)}if(b){this._data=b;this.processData(b,a);this._hasProcessed=true}};SaikuRenderer.prototype.render=function(c,a){var b=null;if(Backbone){this.trigger("render:start",this)}if(!this.hasProcessedData()){this.processData(c,a)}b=this._render(c,a);if(Backbone){this.trigger("render:end",this)}return b};SaikuRenderer.prototype.processData=function(b,a){this.trigger("processData:start",this);this._processData(b,a);this.trigger("processData:end",this)};SaikuRenderer.prototype.hasProcessedData=function(){return this._hasProcessed};SaikuRenderer.prototype._render=function(b,a){};SaikuRenderer.prototype._processData=function(b,a){};var SaikuTableRenderer=_.extend(SaikuRenderer,{key:"table",});SaikuTableRenderer.prototype._render=function(c,a){if(c){this._data=c}if(a){this._options=_.extend(a,SaikuRendererOptions)}if(typeof this._data=="undefined"){return}if(this._data!=null&&this._data.error!=null){return}if(this._data==null||(this._data.cellset&&this._data.cellset.length===0)){return}var b=this.internalRender(this._data.cellset);if(this._options.htmlObject){$(this._options.htmlObject).html(b)}return b};SaikuTableRenderer.prototype._processData=function(b,a){this._hasProcessed=true};SaikuTableRenderer.prototype.internalRender=function(I,e){var A="";var C=I?I:[];var i;var H;var s;var p=false;var G;var D,w;var f;var l=false;var r=0;var m=[];for(var h=0;h<C.length;h++){i=1;H="";s=false;D=false;w=false;A+="<tr>";for(var g=0;g<C[h].length;g++){var z=I[h][g];if(z.type==="COLUMN_HEADER"&&z.value==="null"&&(G==null||g<G)){A+='<th class="all_null"><div>&nbsp;</div></th>'}else{if(z.type==="COLUMN_HEADER"){if(G==null){G=g}if(C[h].length==g+1){D=true}else{f=I[h][g+1]}if(D){if(z.value=="null"){A+='<th class="col_null"><div>&nbsp;</div></th>'}else{A+='<th class="col" style="text-align: center;" colspan="'+i+'" title="'+z.value+'"><div rel="'+h+":"+g+'">'+z.value+"</div></th>"}}else{var n=(g>1&&h>1&&!s&&g>G)?I[h-1][g+1].value!=I[h-1][g].value:false;var F=i>999?true:false;if(z.value!=f.value||s||n||F){if(z.value=="null"){A+='<th class="col_null" colspan="'+i+'"><div>&nbsp;</div></th>'}else{A+='<th class="col" style="text-align: center;" colspan="'+(i==0?1:i)+'" title="'+z.value+'"><div rel="'+h+":"+g+'">'+z.value+"</div></th>"}i=1}else{i++}}}else{if(z.type==="ROW_HEADER"&&z.value==="null"){A+='<th class="row_null"><div>&nbsp;</div></th>'}else{if(z.type==="ROW_HEADER"){if(r==g){s=true}else{f=I[h][g+1]}var E=I[h-1];var y=!s&&(g==0||E[g-1].value==I[h][g-1].value)&&z.value===E[g].value;var t=(y?"<div>&nbsp;</div>":'<div rel="'+h+":"+g+'">'+z.value+"</div>");var x="";var d=(y?"row_null":"row");var b=0;if(!s&&(typeof f=="undefined"||f.value==="null")){b=1;var j=z.properties.dimension;var a=z.properties.level;var o=(j in m?m[j].length-m[j].indexOf(a):1);for(var v=g+1;b<o&&v<=(r+1)&&I[h][v]!=="null";v++){b=v-g}g=g+b-1}A+='<th class="'+d+'" '+(b>0?' colspan="'+b+'"':"")+x+">"+t+"</th>"}else{if(z.type==="ROW_HEADER_HEADER"){A+='<th class="row_header"><div>'+z.value+"</div></th>";s=true;l=true;r=g;if(z.properties.hasOwnProperty("dimension")){var j=z.properties.dimension;if(!(j in m)){m[j]=[]}m[j].push(z.properties.level)}}else{if(z.type==="DATA_CELL"){var u="";var J=z.value;var c="";if(z.properties.hasOwnProperty("image")){var B=z.properties.hasOwnProperty("image_height")?" height='"+z.properties.image_height+"'":"";var q=z.properties.hasOwnProperty("image_width")?" width='"+z.properties.image_width+"'":"";J="<img "+B+" "+q+" style='padding-left: 5px' src='"+z.properties.image+"' border='0'>"}if(z.properties.hasOwnProperty("style")){u=" style='background-color: "+z.properties.style+"' "}if(z.properties.hasOwnProperty("link")){J="<a target='__blank' href='"+z.properties.link+"'>"+J+"</a>"}if(z.properties.hasOwnProperty("arrow")){c="<img height='10' width='10' style='padding-left: 5px' src='./images/arrow-"+z.properties.arrow+".gif' border='0'>"}A+='<td class="data" '+u+'><div alt="'+z.properties.raw+'" rel="'+z.properties.position+'">'+J+c+"</div></td>"}}}}}}}A+="</tr>"}return"<table>"+A+"</table>"};var SaikuChartRenderer=function(d,b){this.rawdata=d;this.cccOptions={};this.data=null,this.hasProcessed=false;this.hasRendered=false;if(!b&&!b.hasOwnProperty("htmlObject")){throw ("You need to supply a html object in the options for the SaikuChartRenderer!")}this.el=$(b.htmlObject);this.id=_.uniqueId("chart_");$('<div class="canvas_wrapper" style="display:none;"><div id="canvas_'+this.id+'"></div></div>').appendTo($(this.el));if(b.zoom){var a=this;var c="<span style='float:left;' class='zoombuttons'><a href='#' class='button rerender' title='Re-render chart'></a><a href='#' class='button zoomout' style='display:none;' title='Zoom back out'></a></span>";$(c).prependTo($(this.el).find(".canvas_wrapper"));$(this.el).find(".zoomout").on("click",function(e){e.preventDefault();a.zoomout()});$(this.el).find(".zoomin").on("click",function(e){e.preventDefault();a.zoomin()});$(this.el).find(".rerender").on("click",function(e){e.preventDefault();$(a.el).find(".zoomout").hide();a.switch_chart(a.type)})}if(b.chartDefinition){this.chartDefinition=b.chartDefinition}this.cccOptions.canvas="canvas_"+this.id;this.data=null;this.adjustSizeTo=null;if(b.adjustSizeTo){this.adjustSizeTo=b.adjustSizeTo}else{this.adjustSizeTo=b.htmlObject}if(this.rawdata){if(this.type=="sunburst"){this.process_data_tree({data:this.rawdata})}else{this.process_data_tree({data:this.rawdata},true,true)}}if(b.mode){this.switch_chart(b.mode)}else{this.switch_chart("stackedBar")}this.adjust()};SaikuChartRenderer.prototype.adjust=function(){var a=this;var c=function(){if(a.hasRendered&&$(a.el).is(":visible")){a.switch_chart(a.type)}};var b=_.debounce(c,300);$(window).resize(function(){$(a.el).find(".canvas_wrapper").fadeOut(150);b()})};SaikuChartRenderer.prototype.zoomin=function(){$(this.el).find(".canvas_wrapper").hide();var a=this.chart.root;var b=a.data;b.datums(null,{selected:false}).each(function(c){c.setVisible(false)});b.clearSelected();a.render(true,true,false);this.render_chart_element()},SaikuChartRenderer.prototype.zoomout=function(){var c=this.chart.root;var d=c.data;var e=c.keptVisibleDatumSet;if(e==null||e.length==0){$(this.el).find(".zoomout").hide()}else{if(e.length==1){$(this.el).find(".zoomout").hide();c.keptVisibleDatumSet=[];pvc.data.Data.setVisible(d.datums(null,{visible:false}),true)}else{if(e.length>1){c.keptVisibleDatumSet.splice(e.length-1,1);var a=d.datums(null,{visible:false}).array();var b=c.keptVisibleDatumSet[e.length-1];_.intersection(b,a).forEach(function(f){f.setVisible(true)})}}}c.render(true,true,false)};SaikuChartRenderer.prototype.render=function(){_.delay(this.render_chart_element,0,this)};SaikuChartRenderer.prototype.switch_chart=function(a){var b={stackedBar:{type:"BarChart",stacked:true},bar:{type:"BarChart"},multiplebar:{type:"BarChart",multiChartIndexes:[1],dataMeasuresInColumns:true,orientation:"vertical",smallTitlePosition:"top",multiChartMax:30,multiChartColumnsMax:Math.floor(this.cccOptions.width/200),smallWidth:200,smallHeight:150},line:{type:"LineChart"},pie:{type:"PieChart",multiChartIndexes:[0]},heatgrid:{type:"HeatGridChart"},stackedBar100:{type:"NormalizedBarChart"},area:{type:"StackedAreaChart"},dot:{type:"DotChart"},waterfall:{type:"WaterfallChart"},treemap:{type:"TreemapChart"}};if(a=="sunburst"){$(this.el).find(".zoombuttons a").hide();this.type=a;this.sunburst();if(this.hasProcessed){this.render()}}else{if(b.hasOwnProperty(a)){$(this.el).find(".zoombuttons a").hide();this.type=a;var c=b[a];this.cccOptions=this.getQuickOptions(c);this.define_chart();if(this.hasProcessed){this.render()}}else{alert("Do not support chart type: '"+a+"'")}}};SaikuChartRenderer.prototype.sunburst=function(){this.type="sunburst";var d=this.process_data_tree({data:this.rawdata});var i=this.getQuickOptions({});function g(j){return j.parentNode?(g(j.parentNode)+"."+j.nodeName):j.nodeName}var h="",a=pv.dom(d).nodes();var f={delayIn:200,delayOut:80,offset:2,html:true,gravity:"nw",fade:false,followMouse:true,corners:true,arrow:false,opacity:1};var c=pv.colors(i.colors).by(function(j){return j.parentNode&&j.parentNode.nodeName});var b=new pv.Panel().width(i.width).height(i.height).canvas(i.canvas);var e=b.add(pv.Layout.Partition.Fill).nodes(a).size(function(j){return j.nodeValue}).order("descending").orient("radial");e.node.add(pv.Wedge).fillStyle(pv.colors(i.colors).by(function(j){return j.parentNode&&j.parentNode.nodeName})).visible(function(j){return j.depth>0}).strokeStyle("#000").lineWidth(0.5).text(function(k){var j="";if(typeof k.nodeValue!="undefined"){j=" : "+k.nodeValue}return(k.nodeName+j)}).cursor("pointer").events("all").event("mousemove",pv.Behavior.tipsy(f));e.label.add(pv.Label).visible(function(j){return j.angle*j.outerRadius>=6});this.chart=b};SaikuChartRenderer.prototype.cccOptionsDefault={Base:{animate:false,selectable:true,valuesVisible:false,legend:true,legendPosition:"top",legendAlign:"right",legendSizeMax:"30%",axisSizeMax:"40%",plotFrameVisible:false,orthoAxisMinorTicks:false,colors:["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"]},HeatGridChart:{orientation:"horizontal",useShapes:true,shape:"circle",nullShape:"cross",colorNormByCategory:false,sizeRole:"value",legendPosition:"right",legend:true,hoverable:true,axisComposite:true,colors:["red","yellow","lightgreen","darkgreen"],yAxisSize:"20%"},WaterfallChart:{orientation:"horizontal"},PieChart:{multiChartColumnsMax:3,multiChartMax:30,smallTitleFont:"bold 14px sans-serif",valuesVisible:true,valuesMask:"{value.percent}",explodedSliceRadius:"10%",extensionPoints:{slice_innerRadiusEx:"40%",slice_offsetRadius:function(a){return a.isSelected()?"10%":0}},clickable:true},LineChart:{extensionPoints:{area_interpolate:"monotone",line_interpolate:"monotone"}},StackedAreaChart:{extensionPoints:{area_interpolate:"monotone",line_interpolate:"monotone"}},TreemapChart:{legendPosition:"right",multiChartIndexes:0,extensionPoints:{leaf_lineWidth:2},layoutMode:"slice-and-dice",valuesVisible:true}};SaikuChartRenderer.prototype.getQuickOptions=function(b){var d=(b&&b.type)||"BarChart";var a=_.extend({type:d,canvas:"canvas_"+this.id},this.cccOptionsDefault.Base,this.cccOptionsDefault[d],b);if(this.adjustSizeTo){var e=$(this.adjustSizeTo);if(e&&e.length>0){var c=e.width()-40;var f=e.height()-40;if(c>0){a.width=c}if(f>0){a.height=f}}}if(this.data!=null&&this.data.resultset.length>5){if(a.type==="HeatGridChart"){}else{if(a.orientation!=="horizontal"){a.extensionPoints=_.extend(Object.create(a.extensionPoints||{}),{xAxisLabel_textAngle:-Math.PI/2,xAxisLabel_textAlign:"right",xAxisLabel_textBaseline:"middle"})}}}return a};SaikuChartRenderer.prototype.define_chart=function(f){if(!this.hasProcessed){this.process_data_tree({data:this.rawdata},true,true)}var k=this;var g=(this.adjustSizeTo?$(this.adjustSizeTo):$(this.el));var e=(this.data!=null&&this.data.height<80&&this.data.width<80);var i=(this.data!=null&&this.data.height<300&&this.data.width<300);var d=(!e&&!i);var b=false;var a=e;var j=g.width()-40;var h=g.height()-40;var c=_.clone(this.cccOptions);if(f&&f.width){j=f.width}if(f&&f.height){h=f.height}if(j>0){c.width=j}if(h>0){c.height=h}if(d){if(c.hasOwnProperty("extensionPoints")&&c.extensionPoints.hasOwnProperty("line_interpolate")){delete c.extensionPoints.line_interpolate}if(c.hasOwnProperty("extensionPoints")&&c.extensionPoints.hasOwnProperty("area_interpolate")){delete c.extensionPoints.area_interpolate}}c=_.extend(c,{hoverable:a,animate:b,legend:{scenes:{item:{execute:function(){var n=this.chart();if(!n.hasOwnProperty("keptVisibleDatumSet")){n.keptVisibleDatumSet=[]}var m=n.keptVisibleDatumSet.length>0?n.keptVisibleDatumSet[n.keptVisibleDatumSet.length-1]:[];var l=m.length>0;if(l){_.intersection(this.datums().array(),m).forEach(function(o){o.toggleVisible()})}else{pvc.data.Data.toggleVisible(this.datums())}this.chart().render(true,true,false)}}}},userSelectionAction:function(m){if(m.length==0){return[]}var p=k.chart.root;var o=p.data;var t=this.chart;if(!t.hasOwnProperty("keptVisibleDatumSet")){t.keptVisibleDatumSet=[]}if(o.datums().count()>1500){pvc.data.Data.setSelected(m,true)}else{if(o.datums(null,{visible:true}).count()==o.datums().count()){$(k.el).find(".zoomout, .rerender").show();var r=o.datums().array();_.each(_.difference(r,m),function(u){u.setVisible(false)});t.keptVisibleDatumSet=[];t.keptVisibleDatumSet.push(m)}else{var l=t.keptVisibleDatumSet.length>0?t.keptVisibleDatumSet[t.keptVisibleDatumSet.length-1]:[];var s=o.datums(null,{visible:true}).array();var n=l;if(s.length<l.length){n=s;t.keptVisibleDatumSet.push(s)}var q=[];_.each(_.difference(s,m),function(u){u.setVisible(false)});_.each(_.intersection(s,m),function(u){q.push(u)});if(q.length>0){t.keptVisibleDatumSet.push(q)}}}p.render(true,true,false);return[]}},this.chartDefinition);if(c.type=="TreemapChart"){c.legend.scenes.item.labelText=function(){var l="";var m=this.group;if(m){var n=m.depth;switch(n){case 0:return"";case 1:break;case 2:l=" └ ";break;default:l=new Array(2*(n-2)+1).join(" ")+" └ "}}return l+this.base()}}this.chart=new pvc[c.type](c);this.chart.setData(this.data,{crosstabMode:true,seriesInRows:false})};SaikuChartRenderer.prototype.render_chart_element=function(c){var b=c||this;var f=(b.data!=null&&b.data.height<80&&b.data.width<80);var h=(b.data!=null&&b.data.height<300&&b.data.width<300);var d=(!f&&!h);var a=false;if(b.chart.options&&b.chart.options.animate){a=true}if(!a||$(b.el).find(".canvas_wrapper").is(":visible")){$(b.el).find(".canvas_wrapper").hide()}try{if(a){$(b.el).find(".canvas_wrapper").show()}b.chart.render();b.hasRendered=true}catch(g){$(b.el).find(".canvas_wrapper").text("Could not render chart"+g)}if(b.chart.options&&b.chart.options.animate){return false}if(isIE||d){$(b.el).find(".canvas_wrapper").show()}else{$(b.el).find(".canvas_wrapper").fadeIn(400)}return false};SaikuChartRenderer.prototype.process_data_tree=function(e,q,B){var v=this;var A={};if(q){A.resultset=[];A.metadata=[];A.height=0;A.width=0}var u=A;if(typeof e=="undefined"||typeof e.data=="undefined"){return}if(e.data!=null&&e.data.error!=null){return}if(e.data==null||(e.data.cellset&&e.data.cellset.length===0)){return}var x=e.data.cellset;if(x&&x.length>0){var g=0;var a=0;var y=false;for(var l=0;a==0&&l<x.length;l++){for(var c=0;c<x[l].length;c++){if(!y){while(x[l][c].type=="COLUMN_HEADER"&&x[l][c].value=="null"){l++}}y=true;if(x[l][c].type=="ROW_HEADER_HEADER"){while(x[l][c].type=="ROW_HEADER_HEADER"){if(q){A.metadata.push({colIndex:c,colType:"String",colName:x[l][c].value})}c++}g=c-1}if(x[l][c].type=="COLUMN_HEADER"){var z=0;var m=[];while(z<=l){if(x[z][c].value!=="null"){m.push(x[z][c].value)}z++}if(q){A.metadata.push({colIndex:c,colType:"Numeric",colName:m.join(" ~ ")})}a=l+1}}}var r={};var p=[];for(var t=0;t<=g;t++){p.push(null)}for(var l=a;l<x.length;l++){if(x[l][0].value!==""){var f=[];var k=[];var o=null;var j=null;for(var t=0;t<=g;t++){if(x[l]&&x[l][t].value==="null"){u=A;var n=0;for(;n<g&&x[l][n].value==="null";n++){u=u[p[n]]}if(n>t){t=n}}if(x[l]&&x[l][t].value!=="null"){if(t==0){for(var i=0;i<=g;i++){p[i]=null}}if(typeof u=="number"){o[j]={};u=o[j]}j=x[l][t].value;p[t]=j;if(!u.hasOwnProperty(j)){u[j]={}}o=u;u=u[j]}}k=_.clone(p);for(var h=g+1;h<x[l].length;h++){var b=x[l][h];var w=b.value||0;var s=b.properties.raw;if(s&&s!=="null"){w=parseFloat(s)}else{if(typeof(b.value)!=="number"&&parseFloat(b.value.replace(/[^a-zA-Z 0-9.]+/g,""))){w=parseFloat(b.value.replace(/[^a-zA-Z 0-9.]+/g,""))}}f.push(w);k.push(w)}if(q){A.resultset.push(k)}var d=_.reduce(f,function(C,D){return C+D},0);o[j]=d;u=A}}if(B){v.rawdata=e.data;v.data=A;v.hasProcessed=true;v.data.height=v.data.resultset.length}return A}else{$(v.el).find(".canvas_wrapper").text("No results").show()}};var Tab=Backbone.View.extend({tagName:"li",events:{"click a":"select","mousedown a":"remove","click .close_tab":"remove"},template:function(){return _.template("<a class='saikutab' href='#<%= id %>'><%= caption %></a><span class='close_tab sprite'>Close tab</span>")({id:this.id,caption:this.caption})},initialize:function(a){_.extend(this,Backbone.Events);_.extend(this,a);this.content.tab=this;this.caption=this.content.caption();this.id=_.uniqueId("tab_")},render:function(){var a=this;this.content.render();$(this.el).html(this.template());$.contextMenu("destroy",".saikutab");$.contextMenu({selector:".saikutab",callback:function(c,b){var e=b.$trigger.attr("href").replace("#","");var d=Saiku.tabs.find(e);if(c=="closethis"){d.remove();a.select();return}else{if(c=="new"){Saiku.tabs.new_tab()}else{if(c=="closeothers"){d.select();Saiku.tabs.close_others(d)}}}},items:{"new":{name:"<span class='i18n'>New</span>"},closethis:{name:"<span class='i18n'>Close This</span>"},closeothers:{name:"<span class='i18n'>Close Others</span>"}}});return this},set_caption:function(a){$(this.el).find(".saikutab").html(a)},destroy:function(){if(this.content&&this.content.query){this.content.query.destroy()}},select:function(){var a=this;this.parent.select(this);$(this.el).addClass("selected");this.trigger("tab:select");return false},remove:function(a){if(!a||a.which===2||$(a.target).hasClass("close_tab")){this.parent.remove(this);try{$(this.el).remove();this.destroy()}catch(b){Log.log(JSON.stringify({Message:"Tab could not be removed",Tab:JSON.stringify(this)}))}}return false}});var TabPager=Backbone.View.extend({className:"pager_contents",events:{"click a":"select"},initialize:function(a){this.tabset=a.tabset;$(this.el).hide().appendTo("body");$(window).click(function(b){if(!$(b.target).hasClass("pager_contents")){$(".pager_contents").hide()}})},render:function(){var a="";for(var b=0;b<this.tabset._tabs.length;b++){a+="<a href='#"+b+"'>"+this.tabset._tabs[b].caption+"</a><br />"}$(this.el).html(a)},select:function(b){var a=$(b.target).attr("href").replace("#","");this.tabset._tabs[a].select();$(this.el).hide();b.preventDefault();return false}});var TabSet=Backbone.View.extend({className:"tabs",queryCount:0,events:{"click a.pager":"togglePager","click a.new":"new_tab"},_tabs:[],render:function(){$(this.el).html('<a href="#pager" class="pager sprite"></a><ul><li class="newtab"><a class="new">+&nbsp;&nbsp;</a></li></ul>').appendTo($("#header"));this.content=$('<div id="tab_panel">').appendTo($("body"));this.pager=new TabPager({tabset:this});return this},add:function(b){this.queryCount++;var a=new Tab({content:b});this._tabs.push(a);a.parent=this;a.render().select();$(a.el).insertBefore($(this.el).find("ul li.newtab"));Saiku.session.trigger("tab:add",{tab:a});this.pager.render();return a},find:function(b){for(var a=0;a<this._tabs.length;a++){if(this._tabs[a].id==b){return this._tabs[a]}}return null},select:function(a){$(this.el).find("li").removeClass("selected");this.content.children().detach();this.content.append($(a.content.el))},remove:function(c){if(this._tabs.length==1){this.add(new Workspace())}for(var a=0;a<this._tabs.length;a++){if(this._tabs[a]==c){this._tabs.splice(a,1);Saiku.session.trigger("tab:remove",{tab:c});this.pager.render();var b=this._tabs[a]?a:(this._tabs.length-1);this._tabs[b].select()}}return true},close_others:function(c){var a=_.indexOf(this._tabs,c);this._tabs[a].select();for(var b=0;b<this._tabs.length;b++){if(this._tabs[b]!=c){var d=this._tabs[b];d.remove();b--}}},togglePager:function(){$(this.pager.el).toggle();return false},new_tab:function(){this.add(new Workspace());var a=this._tabs.length-1;this._tabs[a].select();return false}});var Cube=Backbone.Model.extend({initialize:function(a){this.url=Saiku.session.username+"/discover/"+a.key+"/metadata"},parse:function(a){this.set({template_measures:_.template($("#template-measures").html())({measures:a.measures}),template_dimensions:_.template($("#template-dimensions").html())({dimensions:a.dimensions}),data:a});typeof localStorage!=="undefined"&&localStorage&&localStorage.setItem("cube."+this.get("key"),JSON.stringify(this));return a}});var DimensionList=Backbone.View.extend({events:{"click span":"select","click a":"select","click .parent_dimension ul li a.level":"select_dimension","click .measure":"select_measure"},initialize:function(a){_.bindAll(this,"render","load_dimension","select_dimension");this.workspace=a.workspace;this.dimension=a.dimension;this.type=a.type;if(a.dimension&&a.dimension.has("template_"+a.type)){this.load_dimension()}else{if(!a.dimension){$(this.el).html("Could not load dimension. Please log out and log in again.")}else{$(this.el).html("Loading...");this.workspace.bind("cube:loaded",this.load_dimension)}}},load_dimension:function(){this.template=this.dimension.get("template_"+this.type);this.render();this.workspace.trigger("dimensions:loaded",$(this.el))},render:function(){var a=this;$(this.el).hide().html(this.template);if(isIE&&isIE<=8){$(this.el).show()}else{$(this.el).fadeTo(500,1)}$(this.el).find(".measure,.level").parent("li").mousedown(function(b,c){b.preventDefault();if($(b.target).parent().hasClass("ui-state-disabled")){return}if(a.workspace.query.get("type")=="QM"){if($(a.workspace.toolbar.el).find(".toggle_fields").hasClass("on")&&$(a.workspace.el).find(".workspace_editor").is(":hidden")){a.workspace.toolbar.toggle_fields()}}});$(this.el).find(".measure,.level").parent("li").draggable({cancel:".not-draggable, .hierarchy",connectToSortable:$(this.workspace.el).find(".columns > ul, .rows > ul, .filter > ul"),helper:"clone",opacity:0.6,tolerance:"touch",stop:function(){if(a.workspace.query.get("type")=="QM"){if($(a.workspace.toolbar.el).find(".toggle_fields").hasClass("on")){a.workspace.toolbar.toggle_fields()}}},cursorAt:{top:10,left:35}})},select:function(b){var a=$(b.target).hasClass("root")?$(b.target):$(b.target).parent().find("span");if(a.hasClass("root")){a.find("a").toggleClass("folder_collapsed").toggleClass("folder_expand");a.toggleClass("collapsed").toggleClass("expand");a.parents("li").find("ul").children("li").toggle()}return false},select_dimension:function(e,f){if(this.workspace.query.get("type")!="QM"){return}if($(e.target).parent().hasClass("ui-state-disabled")){e.preventDefault();e.stopPropagation();return}var g=false;var c=$(e.target).attr("href");var d=c.substring(0,_.lastIndexOf(c,"/"));var b=null;if($(this.workspace.el).find(".workspace_fields ul li a[href^='"+d+"']:first").length>0){b=$(this.workspace.el).find(".workspace_fields ul li a[href^='"+d+"']").parent().parent()}else{b=$(this.workspace.el).find(".columns ul li").length>0?$(this.workspace.el).find(".rows ul"):$(this.workspace.el).find(".columns ul")}var a=$(e.target).parent().clone().appendTo(b);this.workspace.drop_zones.select_dimension({target:b},{item:a});if($(this.workspace.toolbar.el).find(".toggle_fields").hasClass("on")){$(this.workspace.el).find(".workspace_editor").delay(2000).slideUp({complete:this.workspace.adjust})}e.preventDefault();return false},select_measure:function(c,d){if($(c.target).parent().hasClass("ui-state-disabled")){return}var b;if($(this.workspace.el).find(".rows ul .d_measure").length>0){b=$(this.workspace.el).find(".rows ul")}else{if($(this.workspace.el).find(".columns ul .d_measure").length>0){b=$(this.workspace.el).find(".columns ul")}else{if($(this.workspace.el).find(".filter ul .d_measure").length>0){b=$(this.workspace.el).find(".filter ul")}else{b=$(this.workspace.el).find(".columns ul")}}}var a=$(c.target).parent().clone();if(b.find(".d_measure").length!=0){a.insertAfter(b.find(".d_measure:last"))}else{a.appendTo(b)}this.workspace.drop_zones.select_dimension({target:b},{item:a});if($(this.workspace.toolbar.el).find(".toggle_fields").hasClass("on")){$(this.workspace.el).find(".workspace_editor").delay(2000).slideUp({complete:this.workspace.adjust})}c.preventDefault();return false}});var Toolbar=Backbone.View.extend({tagName:"div",events:{"click a":"call"},template:function(){return _.template($("#template-toolbar").html())(this)},initialize:function(){this.render()},render:function(){$(this.el).attr("id","toolbar").html(this.template());Saiku.events.trigger("toolbar:render",{toolbar:this});return this},call:function(b){var a=$(b.target);var c=a.attr("href").replace("#","");if(this[c]){this[c](b)}b.preventDefault()},new_query:function(){Saiku.tabs.add(new Workspace());return false},open_query:function(){var a=_.detect(Saiku.tabs._tabs,function(b){return b.content instanceof OpenQuery});if(a){a.select()}else{Saiku.tabs.add(new OpenQuery())}return false},logout:function(){Saiku.session.logout()},about:function(){(new AboutModal).render().open();return false},issue_tracker:function(){window.open("https://github.com/OSBI/saiku/issues/new");return false}});var Modal=Backbone.View.extend({tagName:"div",className:"dialog",type:"modal",message:"Put content here",options:{autoOpen:false,modal:true,title:"Modal dialog",resizable:false,draggable:true},events:{"click a":"call"},buttons:[{text:"OK",method:"close"}],template:function(){return _.template("<div class='dialog_icon'></div><div class='dialog_body'><%= message %></div><div class='dialog_footer'><% _.each(buttons, function(button) { %><a class='form_button' href='#<%= button.method %>'>&nbsp;<%= button.text %>&nbsp;</a><% }); %></div>")(this)},initialize:function(a){_.extend(this,a);_.bindAll(this,"call");_.extend(this,Backbone.Events)},render:function(){$(this.el).html(this.template()).addClass("dialog_"+this.type).dialog(this.options);$(".ui-dialog-title").html(this.options.title);Saiku.i18n.translate();return this},call:function(a){var b=a.target.hash.replace("#","");if(!$(a.target).hasClass("disabled_toolbar")&&this[b]){this[b](a)}return false},open:function(){$(this.el).dialog("open");this.trigger("open",{modal:this});return this},close:function(){$(this.el).dialog("destroy").remove();$(this.el).remove();return false}});var MDXModal=Modal.extend({type:"mdx",initialize:function(a){this.options.title="MDX";this.message=_.template("<textarea><%= mdx %></textarea>")(a);this.bind("open",function(){var b=this;$(b.el).parents(".ui-dialog").css({width:"550px"})})}});var SelectionsModal=Modal.extend({type:"selections",buttons:[{text:"OK",method:"save"},{text:"Cancel",method:"close"}],events:{"click a":"call","click .search_term":"search_members","click .clear_search":"clear_search","change #show_unique":"show_unique_action","change #use_result":"use_result_action","dblclick select option":"click_move_selection","click div.selection_buttons a.form_button":"move_selection","click div.updown_buttons a.form_button":"updown_selection"},show_unique_option:false,use_result_option:Settings.MEMBERS_FROM_RESULT,members_limit:Settings.MEMBERS_LIMIT,members_search_limit:Settings.MEMBERS_SEARCH_LIMIT,members_search_server:false,initialize:function(a){_.extend(this,a);this.options.title="<span class='i18n'>Selections for</span> "+this.name;this.message="Fetching members...";this.query=a.workspace.query;this.selected_members=[];this.available_members=[];_.bindAll(this,"fetch_members","populate","finished","get_members","use_result_action");this.axis="undefined";if(a.axis){this.axis=a.axis;if(a.axis=="FILTER"){this.use_result_option=false}}else{if(a.target.parents(".fields_list_body").hasClass("rows")){this.axis="ROWS"}if(a.target.parents(".fields_list_body").hasClass("columns")){this.axis="COLUMNS"}if(a.target.parents(".fields_list_body").hasClass("filter")){this.axis="FILTER";this.use_result_option=false}}this.bind("open",this.post_render);this.render();$(this.el).parent().find(".ui-dialog-titlebar-close").bind("click",this.finished);this.member=new Member({},{cube:a.workspace.selected_cube,dimension:a.key});$(this.el).find(".dialog_body").html(_.template($("#template-selections").html())(this));$(this.el).find("#use_result").attr("checked",this.use_result_option);$(this.el).find(".search_limit").text(this.members_search_limit);$(this.el).find(".members_limit").text(this.members_limit);this.get_members()},get_members:function(){var a=this;var c="/result/metadata/dimensions/"+this.member.dimension+"/hierarchies/"+this.member.hierarchy+"/levels/"+this.member.level;this.search_path=c;var b='<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">'+a.message+"</span> ";a.workspace.block(b);this.workspace.query.action.get(c,{success:this.fetch_members,error:function(){a.workspace.unblock()},data:{result:this.use_result_option,searchlimit:this.members_limit}})},clear_search:function(){$(this.el).find(".filterbox").val("");this.get_members()},search_members:function(){var a=this;var c=$(this.el).find(".filterbox").val();if(!c){return false}var b='<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">Searching for members matching:</span> '+c;a.workspace.block(b);a.workspace.query.action.get(a.search_path,{async:false,success:function(d,e){if(e&&e.length>0){a.available_members=e}a.populate()},error:function(){a.workspace.unblock()},data:{search:c,searchlimit:a.members_search_limit}})},fetch_members:function(c,b){var a=this;if(b&&b.length>0){this.available_members=b}this.workspace.query.action.get("/axis/"+this.axis+"/dimension/"+this.member.dimension,{success:this.populate,error:function(){a.workspace.unblock()}})},populate:function(k,d){var m=this;m.workspace.unblock();this.members_search_server=(this.available_members.length>=this.members_limit||this.available_members.length==0);$(this.el).find(".items_size").text(this.available_members.length);if(this.members_search_server){$(this.el).find(".warning").text("More items available than listed. Pre-Filter on server.")}else{$(this.el).find(".warning").text("")}if(d&&d.hasOwnProperty("selections")){this.selected_members=d.selections}var h=[];$(this.el).find(".used_selections select").removeAttr("disabled");var c="";for(var e=0;e<this.selected_members.length;e++){var g=this.selected_members[e];if(g.levelUniqueName==decodeURIComponent(this.member.level)&&g.type=="MEMBER"){c+='<option value="'+encodeURIComponent(g.uniqueName)+'">'+g.caption+"</option>";h.push(g.caption)}}if(h.length>0){var l=$(this.el).find(".used_selections select");l.empty();$(c).appendTo(l)}this.available_members=_.select(this.available_members,function(i){return h.indexOf(i.caption)===-1});$(this.el).find(".available_selections select").removeAttr("disabled");var b="";for(var f=0;f<this.available_members.length;f++){var g=this.available_members[f];b+='<option value="'+encodeURIComponent(g.uniqueName)+'">'+g.caption+"</option>"}if(this.available_members.length>0){var a=$(this.el).find(".available_selections select");a.empty();$(b).appendTo(a)}$(this.el).find(".filterbox").autocomplete({minLength:1,delay:200,appendTo:".autocomplete",source:function(o,j){var p=m.available_members;var n=m.show_unique_option==false?"caption":"name";var i=$.map(p,function(r){if(r[n].toLowerCase().indexOf(o.term.toLowerCase())>-1){var q=m.show_unique_option==false?r.caption:r.uniqueName;var s=m.show_unique_option==false?r.uniqueName:r.caption;return{label:q,value:s}}});j(i)},select:function(n,p){var o=encodeURIComponent(p.item.value);var i=p.item.label;$(m.el).find('.available_selections select option[value="'+o+'"]').remove();$(m.el).find('.used_selections select option[value="'+o+'"]').remove();var j='<option value="'+o+'">'+i+"</option>";$(j).appendTo($(m.el).find(".used_selections select"));$(m.el).find(".filterbox").val("");p.item.value=""},close:function(i,j){},open:function(i,j){}});$(this.el).find(".filterbox").autocomplete("enable");Saiku.i18n.translate();Saiku.ui.unblock()},post_render:function(a){var b=($(window).width()-1000)/2;$(a.modal.el).parents(".ui-dialog").css({width:1040,left:"inherit",margin:"0",height:465}).offset({left:b})},move_selection:function(c){c.preventDefault();var d=$(c.target).attr("id");var e=d.indexOf("add")!==-1?$(this.el).find(".used_selections select"):$(this.el).find(".available_selections select");var b=d.indexOf("add")!==-1?$(this.el).find(".available_selections select"):$(this.el).find(".used_selections select");var a=d.indexOf("all")!==-1?b.find("option"):b.find("option:selected");a.detach().appendTo(e)},updown_selection:function(a){a.preventDefault();var b=$(a.target).attr("href").replace("#","");if(typeof b!="undefined"){if("up"==b){$(this.el).find(".used_selections option:selected").insertBefore($(".used_selections option:selected:first").prev())}else{if("down"==b){$(this.el).find(".used_selections option:selected").insertAfter($(".used_selections option:selected:last").next())}}}},click_move_selection:function(a,b){var c=($(a.target).parent().parent().hasClass("used_selections"))?".available_selections":".used_selections";$(a.target).appendTo($(this.el).find(c+" select"))},show_unique_action:function(){$.each($(this.el).find("option"),function(a,b){var c=$(b).text();$(b).text(decodeURIComponent($(b).val()));$(b).val(encodeURIComponent(c))});this.show_unique_option=!this.show_unique_option},use_result_action:function(){this.use_result_option=!this.use_result_option;this.get_members()},save:function(){var b=$("<div>Saving...</div>");$(this.el).find(".dialog_body").children().hide();$(this.el).find(".dialog_body").prepend(b);var a=this.show_unique_option;var c=[{hierarchy:decodeURIComponent(this.member.hierarchy),uniquename:decodeURIComponent(this.member.level),type:"level",action:"delete"}];if($(this.el).find(".used_selections option").length===0){c.push({hierarchy:decodeURIComponent(this.member.hierarchy),uniquename:decodeURIComponent(this.member.level),type:"level",action:"add"})}else{$(this.el).find(".used_selections option").each(function(d,e){var f=a?encodeURIComponent($(e).text()):$(e).val();c.push({uniquename:decodeURIComponent(f),type:"member",action:"add"})})}this.query.action.put("/axis/"+this.axis+"/dimension/"+this.member.dimension,{success:this.finished,dataType:"text",data:{selections:JSON.stringify(c)}});return false},finished:function(){$("#filter_selections").remove();this.available_members=null;$(this.el).find(".filterbox").autocomplete("destroy");$(this.el).dialog("destroy");$(this.el).remove();this.query.run()}});var DrillthroughModal=Modal.extend({type:"drillthrough",buttons:[{text:"Ok",method:"ok"},{text:"Cancel",method:"close"}],events:{"click .collapsed":"select","click .expand":"select","click .folder_collapsed":"select","click .folder_expanded":"select","click .dialog_footer a":"call","click .parent_dimension input":"select_dimension","click .measure_tree input":"select_measure","click input.all_measures":"select_all_measures","click input.all_dimensions":"select_all_dimensions"},initialize:function(f){_.extend(this,f);this.options.title=f.title;this.query=f.workspace.query;this.position=f.position;this.action=f.action;Saiku.ui.unblock();_.bindAll(this,"ok","drilled");this.render();$(this.el).find(".dialog_body").html(_.template($("#template-drillthrough").html())(this));$(this.el).find(".maxrows").val(this.maxrows);var e=this.query.get("schema");var h=this.query.get("connection")+"/"+this.query.get("catalog")+"/"+((e==""||e==null)?"null":e)+"/"+this.query.get("cube");var c=$("#template-drillthrough-list").html();var d=Saiku.session.sessionworkspace.cube[h];var a=null;var b=null;if(d&&d.has("data")){a=d.get("data").dimensions;b=d.get("data").measures}if(!d||!a||!b){if(typeof localStorage!=="undefined"&&localStorage&&localStorage.getItem("cube."+h)!==null){Saiku.session.sessionworkspace.cube[h]=new Cube(JSON.parse(localStorage.getItem("cube."+h)))}else{Saiku.session.sessionworkspace.cube[h]=new Cube({key:h});Saiku.session.sessionworkspace.cube[h].fetch({async:false})}a=Saiku.session.sessionworkspace.cube[h].get("data").dimensions;b=Saiku.session.sessionworkspace.cube[h].get("data").measures}var g=_.template($("#template-drillthrough-dimensions").html())({dimensions:a});var i=_.template($("#template-drillthrough-measures").html())({measures:b});$(c).appendTo($(this.el).find(".dialog_body"));$(this.el).find(".sidebar").height(($("body").height()/2)+($("body").height()/6));$(this.el).find(".sidebar").width(380);$(this.el).find(".dimension_tree").html("").append($(g));$(this.el).find(".measure_tree").html("").append($(i));Saiku.i18n.translate()},select:function(b){var a=$(b.target).hasClass("root")?$(b.target):$(b.target).parent().find("span");if(a.hasClass("root")){a.find("a").toggleClass("folder_collapsed").toggleClass("folder_expand");a.toggleClass("collapsed").toggleClass("expand");a.parents("li").find("ul").children("li").toggle()}return false},select_dimension:function(c){var a=$(c.target);var b=a.is(":checked");a.parent().find("input").attr("checked",b)},select_all_dimensions:function(c){var a=$(c.target);var b=a.is(":checked");$(this.el).find(".dimension_tree input").attr("checked",b)},select_all_measures:function(c){var a=$(c.target);var b=a.is(":checked");$(this.el).find(".measure_tree input").attr("checked",b)},select_measure:function(c){var a=$(c.target);var b=a.is(":checked");if(b){}},ok:function(){var d=$("<div>Drilling through...</div>");$(this.el).find(".dialog_body").children().hide();$(this.el).find(".dialog_body").prepend(d);var c="";$(this.el).find(".check_level:checked").each(function(f){if(f>0){c+=", "}c+=$(this).val()});var b=$(this.el).find(".maxrows").val();var e="?maxrows="+b;e=e+(typeof this.position!=="undefined"?"&position="+this.position:"");e+="&returns="+c;if(this.action=="export"){var a=Settings.REST_URL+Saiku.session.username+"/query/"+this.query.id+"/drillthrough/export/csv"+e;this.close();window.open(a)}else{if(this.action=="table"){Saiku.ui.block("Executing drillthrough...");this.query.action.get("/drillthrough",{data:{position:this.position,maxrows:b,returns:c},success:this.drilled});this.close()}}return false},drilled:function(b,a){var c="";if(a!=null&&a.error!=null){c=safe_tags_replace(a.error)}else{var d=new SaikuTableRenderer();c=d.render(a)}Saiku.ui.unblock();var c='<div id="fancy_results" class="workspace_results" style="overflow:visible">'+c+"</div>";this.remove();$.fancybox(c,{autoDimensions:false,autoScale:false,height:($("body").height()-100),width:($("body").width()-100),transitionIn:"none",transitionOut:"none"})},finished:function(){$(this.el).dialog("destroy").remove();this.query.run()}});var PermissionsModal=Modal.extend({type:"permissions",buttons:[{text:"Ok",method:"ok"},{text:"Cancel",method:"close"}],events:{"click .add_role":"add_role","click .remove_acl":"remove_acl","submit form":"add_role","click a":"call","click input.private":"keep_private"},rolesacl:{},acltype:"SECURED",initialize:function(b){_.extend(this,b);this.options.title=b.title;this.file=b.file;this.rolesacl={};Saiku.ui.unblock();_.bindAll(this,"ok","add_role","remove_acl");this.bind("open",Saiku.i18n.translate());this.render();$(this.el).find(".dialog_body").html(_.template($("#template-permissions").html())(this));$(this.el).find(".filterbox").autocomplete({minLength:1,source:Saiku.session.roles}).data("autocomplete");var f=new RepositoryAclObject({file:this.file});f.fetch({async:false});var d=(typeof f.get("roles")=="undefined"||f.get("roles")==null?{}:f.get("roles"));this.rolesacl=d;var e=_.template($("#template-permissions-rolelist").html())({roles:d});$(this.el).find(".rolelist").html(e);var a=(typeof f.get("owner")=="undefined"||f.get("owner")==null?"":f.get("owner"));var c=(typeof f.get("type")=="undefined"||f.get("type")==null?null:f.get("type"));if(c!=null&&c=="PRIVATE"){$(this.el).find(".private_owner .owner").text(a);$(this.el).find(".private_owner").show()}},add_role:function(d){var a=this;d.preventDefault();if(this.acltype=="PRIVATE"){return false}var f=$(this.el).find(".filterbox").val();var e=[];var c="";var b=0;if(f&&f.length>0){$(this.el).find(".acl:checked").each(function(g){if(g>0){c+=", "}b++;c+=$(this).val();e.push($(this).val())});if(b>0){a.rolesacl[f]=e;$("<option value='"+f+"'>"+f+" ["+c+"]</option>").appendTo($(this.el).find(".select_roles"));var f=$(this.el).find(".filterbox").val("")}else{alert("You need to chose at least one ACL method for this role.")}}return false},keep_private:function(b){var a=$(this.el).find("input.private").is(":checked");if(a){$(this.el).find(".permissions").addClass("disabled_toolbar");$("input.acl, input.filterbox, input.add_role, input.remove_acl").prop("disabled",true);this.acltype="PRIVATE"}else{$(this.el).find(".permissions").removeClass("disabled_toolbar");$("input.acl, input.filterbox, input.add_role, input.remove_acl").prop("disabled",false);this.acltype="SECURED"}},remove_acl:function(b){var a=this;if(this.acltype=="PRIVATE"){return false}$(this.el).find(".select_roles option:selected").each(function(c){delete a.rolesacl[$(this).val()]});$(this.el).find(".select_roles option:selected").remove();return false},ok:function(){var b=this.close();var a={};if(this.acltype=="PRIVATE"){a={type:"PRIVATE",owner:Saiku.session.username}}else{a={type:"SECURED",roles:this.rolesacl,owner:Saiku.session.username}}(new RepositoryAclObject({file:this.file,acl:JSON.stringify(a)})).save({success:b});return false}});var LoginForm=Modal.extend({type:"login",message:"<form id='login_form'><label for='username'>Username</label><input type='text' id='username' name='username' value='' /><label for='password'>Password</label><input type='password' id='password' name='password' value='' /></form>",buttons:[{text:"Login",method:"login"}],events:{"click a":"call","keyup #login_form input":"check"},initialize:function(a){_.extend(this,a);_.bindAll(this,"adjust");this.options.title=Settings.VERSION;this.bind("open",this.adjust)},adjust:function(){$(this.el).parent().find(".ui-dialog-titlebar-close").hide();$(this.el).find("#username").select().focus()},check:function(a){if(a.which===13){this.login()}},login:function(){var a=$(this.el).find("#username").val();var b=$(this.el).find("#password").val();$(this.el).dialog("close");this.session.login(a,b);return true}});var DemoLoginForm=Modal.extend({type:"login",message:"<form id='demo_form'><label for='email'>Email:</label><input type='text' id='email' name='email' value='' /></form>",buttons:[{text:"Start Demo",method:"login"}],events:{"click a":"call","submit form ":"login"},initialize:function(a){_.extend(this,a);_.bindAll(this,"adjust");this.options.title=Settings.VERSION;this.bind("open",this.adjust)},adjust:function(){$(this.el).parent().find(".ui-dialog-titlebar-close").hide();$(this.el).find("#email").select().focus()},login:function(d){var a=Settings.USERNAME;var c=Settings.PASSWORD;var b=$(this.el).find("#email").val();if(b){var f=new logger({url:Settings.TELEMETRY_SERVER+"/input/demo"});f.log({email:b,created_at:Math.round((new Date()).getTime()/1000)});$(this.el).dialog("close");this.session.login(a,c)}if(d){d.preventDefault();d.stopPropagation()}return true}});var AboutModal=Modal.extend({initialize:function(){_.extend(this.options,{title:"About "+Settings.VERSION})},events:{"click a":"dummy"},dummy:function(){return true},type:"info",message:Settings.VERSION+"<br><a  target='_blank' href='http://www.analytical-labs.com'>http://www.analytical-labs.com/</a><br><br>Powered by <img width='20px' src='/images/src/meteorite_free.png'  /> <a target='_blank' href='http://meteorite.bi'>http://meteorite.bi/</a> "});var AddFolderModal=Modal.extend({type:"save",closeText:"Save",events:{"click .form_button":"save","submit form":"save"},buttons:[{text:"OK",method:"save"}],initialize:function(b){var a=this;this.success=b.success;this.path=b.path;this.message="<form id='add_folder'><label for='name'>To add a new folder, please type a name in the text box below:</label><input type='text' class='newfolder' name='name' /></form>";_.extend(this.options,{title:"Add Folder"});if(isIE&&isIE<9){$(this.el).find("form").on("submit",this.save)}},type:"save",save:function(d){d.preventDefault();var a=this;var b=$(this.el).find('input[name="name"]').val();var c=this.path+b;(new SavedQuery({file:c,name:b})).save({},{success:a.success,dataType:"text",error:this.error});this.close();return false},error:function(){$(this.el).find("dialog_body").html("Could not add new folder")}});var FilterModal=Modal.extend({type:"filter",closeText:"Save",events:{"submit form":"save","click .dialog_footer a":"call"},buttons:[{text:"OK",method:"save"},{text:"Cancel",method:"close"}],message:"",expression_text:function(){var a="<form id='custom_filter'><table border='0px'>";if(this.expressionType=="Order"){a+="<tr><td class='col1'>Sort Type: <select id='fun'><option>ASC</option><option>BASC</option><option>DESC</option><option>BDESC</option> </select></td></tr>"}a+="<tr><td class='col1'>"+this.expressionType+" MDX Expression:</td></tr><tr><td class='col1'><textarea class='filter_expression'></textarea></td></tr></table></form>";return a},expression:" ",expressonType:"",initialize:function(b){var a=this;this.axis=b.axis;this.query=b.query;this.success=b.success;this.expression=b.expression;this.expressionType=b.expressionType;_.bindAll(this,"save","expression_text");_.extend(this.options,{title:"Custom "+this.expressionType+" for "+this.axis});this.message=this.expression_text(this.expressionType);this.bind("open",function(){$(this.el).find("textarea").val("").val(a.expression)});if(isIE&&isIE<9){$(this.el).find("form").on("submit",this.save)}},save:function(d){d.preventDefault();var a=this;this.expression=$(this.el).find("textarea").val();var b="";if(typeof this.expression=="undefined"||!this.expression||this.expression==""){b+="You have to enter a MDX expression for the "+this.expressionType+" function! ";alert(b)}else{if(a.expressionType=="Order"){var c=$("#fun").val();a.success(c,this.expression)}else{a.success(this.expression)}this.close()}return false},error:function(){$(this.el).find("dialog_body").html("Could not add new folder")}});var CustomFilterModal=Modal.extend({type:"filter",closeText:"Save",events:{"submit form":"save","change .function":"switch_function","change .type":"switch_type","click .dialog_footer a":"call"},buttons:[{text:"OK",method:"save"},{text:"Cancel",method:"close"}],message:"<form id='custom_filter'><table border='0px'><tr><td class='col0'>Define Filter:</td><td class='col1'><select class='function'><option>Select a Function...</option><option value='TopCount'>TopCount</option><option value='TopPercent'>TopPercent</option><option value='TopSum'>TopSum</option><option value='BottomCount'>BottomCount</option><option value='BottomPercent'>BottomPercent</option><option value='BottomSum'>BottomSum</option></select></td></tr><tr class='filter_details hide'><td><span class='ntype'></span></td><td><input class='n' /></td></tr><tr class='filter_details hide'><td>Sort by:</td><td><select class='type'><option value='measure'>Measure</option><option value='custom'>MDX Expression</option></select></td></tr><tr class='filter_details hide'><td>&nbsp;</td><td class='sortingoption'>&nbsp;</td></table></form>",func:null,func_type:"Measure",n:"",sortliteral:"",measure_list:null,initialize:function(b){var a=this;this.axis=b.axis;this.measures=b.measures;this.query=b.query;this.success=b.success;this.func=b.func;this.n=b.n;this.sortliteral=b.sortliteral;this.isMdx=true;_.bindAll(this,"build_measures_list","save");this.measure_list=this.build_measures_list();_.extend(this.options,{title:"Custom Filter for "+this.axis});this.bind("open",function(){if(a.func!=null){$(a.el).find(".function").val(a.func);a.switch_function({target:$(a.el).find(".function")});$(a.el).find(".n").val(a.n);if(a.isMdx==true&&a.sortliteral!=null){$(this.el).find(".type").val("custom");$(this.el).find(".sortingoption").html("").html("<textarea class='sortliteral'>"+a.sortliteral+"</textarea>")}}});if(isIE&&isIE<9){$(this.el).find("form").on("submit",this.save)}},build_measures_list:function(){var b=this;if(this.measure_list!=null){return""}var a="<select class='sortliteral'>";_.each(this.measures,function(d){var c="";if(d.uniqueName==b.sortliteral){c=" selected ";b.isMdx=false}a+="<option "+c+"value='"+d.uniqueName+"'>"+d.caption+"</option>"});a+="</select>";return a},switch_function:function(b){var c=$(b.target).val();if(typeof c=="undefined"||c==""){$(this.el).find(".filter_details").hide()}else{var a=c.replace("Top","").replace("Bottom","");$(this.el).find(".ntype").html(a+":");$(this.el).find(".filter_details").show();$(this.el).find(".sortingoption").html("").html(this.measure_list)}return false},switch_type:function(b){var a=$(b.target).val();if(a=="measure"){$(this.el).find(".sortingoption").html("").html(this.measure_list)}else{$(this.el).find(".sortingoption").html("").html("<textarea class='sortliteral' />")}return false},save:function(c){c.preventDefault();var a=this;this.func=$(this.el).find(".function").val();this.n=parseInt($(this.el).find(".n").val());this.sortliteral=$(this.el).find(".sortliteral").val();var b="";if(typeof this.n=="undefined"||!this.n){b+="You have to enter a numeric for N! "}if(typeof this.sortliteral=="undefined"||!this.sortliteral||this.sortliteral==""){b+="You have to enter a MDX expression for the sort literal! "}if(b!=""){alert(b)}else{a.success(this.func,this.n,this.sortliteral);this.close()}return false},error:function(){$(this.el).find("dialog_body").html("Could not add new folder")}});var QueryToolbar=Backbone.View.extend({events:{"click .options a.button":"call","click .renderer a.button":"switch_render_button"},chart:{},render_mode:"table",spark_mode:null,initialize:function(a){this.workspace=a.workspace;_.bindAll(this,"call","activate_buttons","spark_bar","spark_line","render_row_viz","run_row_viz","switch_render_button");this.render_mode="table";this.spark_mode=null;this.workspace.bind("query:new",this.activate_buttons);this.workspace.bind("query:result",this.activate_buttons);this.workspace.bind("table:rendered",this.run_row_viz)},activate_buttons:function(a){if(typeof a!="undefined"&&a!=null){$(this.el).find("a").removeClass("disabled_toolbar");if(!a.data){$(this.el).find("a.export_button, a.stats").addClass("disabled_toolbar")}if(isIE){$(this.el).find("a.export_button").addClass("disabled_toolbar")}}},template:function(){var a=$("#template-query-toolbar").html()||"";return _.template(a)()},render:function(){$(this.el).html(this.template());$(this.el).find("render_table").addClass("on");$(this.el).find("ul.table").show();return this},switch_render_button:function(b){var a=$(b.target);b.preventDefault();if($(b.target).hasClass("disabled_toolbar")){return false}a.parent().siblings().find(".on").removeClass("on");if(a.hasClass("render_chart")){this.switch_render("chart");this.workspace.query.setProperty("saiku.ui.render.mode","chart");var d=$(this.el).find("ul.chart li a.on:first").size()>0?$(this.el).find("ul.chart li a.on:first").attr("href").replace("#",""):null;if(d!=null){this.workspace.query.setProperty("saiku.ui.render.type",d)}}else{this.switch_render("table");this.workspace.query.setProperty("saiku.ui.render.mode","table");this.workspace.query.setProperty("saiku.ui.render.type",this.spark_mode)}},switch_render:function(b){b=(typeof b!="undefined"?b.toLowerCase():"table");$(this.el).find("ul.renderer a.on").removeClass("on");$(this.el).find("ul.renderer a.render_"+b).addClass("on");if("chart"==b){$(this.el).find("ul.chart").show();$(this.el).find("ul.table").hide();this.render_mode="chart";$(this.workspace.el).find(".workspace_results").children().hide();$(this.workspace.chart.el).find(".canvas_wrapper").hide();this.workspace.chart.show()}else{$(this.el).find("ul.chart").hide();$(this.el).find("ul.table").show();$(this.el).find("ul.table .stats").removeClass("on");$(this.workspace.el).find(".workspace_results").children().hide();$(this.workspace.el).find(".workspace_results table").show();$(this.workspace.chart.el).hide().children().hide();this.render_mode="table";var a=this.workspace.query.result.hasRun();if(a){this.workspace.table.render({data:this.workspace.query.result.lastresult()})}}return false},call:function(b){var a=$(b.target).hasClass("button")?$(b.target):$(b.target).parent();if(!a.hasClass("disabled_toolbar")){var c=a.attr("href").replace("#","");if(this.render_mode=="table"&&this[c]){this[c](b)}else{if(this.render_mode=="chart"){if(a.hasClass("chartoption")){a.parent().siblings().find(".chartoption.on").removeClass("on");a.addClass("on")}if(c=="export_button"){this.workspace.chart[c](b)}else{this.workspace.chart.renderer.switch_chart(c);this.workspace.query.setProperty("saiku.ui.render.type",c)}}}}b.preventDefault();return false},spark_bar:function(){$(this.el).find("ul.table .spark_bar").toggleClass("on");$(this.el).find("ul.table .spark_line").removeClass("on");$(this.workspace.table.el).find("td.spark").remove();if($(this.el).find("ul.table .spark_bar").hasClass("on")){this.spark_mode="spark_bar";this.workspace.query.setProperty("saiku.ui.render.type","spark_bar");_.delay(this.render_row_viz,10,"spark_bar")}else{this.spark_mode=null}},spark_line:function(){$(this.el).find("ul.table .spark_line").toggleClass("on");$(this.el).find("ul.table .spark_bar").removeClass("on");$(this.workspace.table.el).find("td.spark").remove();if($(this.el).find("ul.table .spark_line").hasClass("on")){this.spark_mode="spark_line";this.workspace.query.setProperty("saiku.ui.render.type","spark_line");_.delay(this.render_row_viz,10,"spark_line")}else{this.spark_mode=null}},run_row_viz:function(a){if(this.render_mode=="table"&&this.spark_mode!=null){this.render_row_viz(this.spark_mode)}},render_row_viz:function(a){$(this.workspace.table.el).find("tr").each(function(b,c){var f=[];$(c).find("td.data div").each(function(g,h){var j=$(h).attr("alt");j=(typeof j!="undefined"&&j!=""&&j!=null&&j!="undefined")?parseFloat(j):0;f.push(j)});$("<td class='data spark'>&nbsp;<div id='chart"+b+"'></div></td>").appendTo($(c));var d=f.length*9;if(f.length>0){var e=new pv.Panel().canvas("chart"+b).height(12).width(d).margin(0);if(a=="spark_bar"){e.add(pv.Bar).data(f).left(pv.Scale.linear(0,f.length).range(0,d).by(pv.index)).height(pv.Scale.linear(0,_.max(f)).range(0,12)).width(6).bottom(0)}else{if(a=="spark_line"){d=d/2;e.width(d);e.add(pv.Line).data(f).left(pv.Scale.linear(0,f.length-1).range(0,d).by(pv.index)).bottom(pv.Scale.linear(f).range(0,12)).strokeStyle("#000").lineWidth(1)}}e.render()}})}});var WorkspaceToolbar=Backbone.View.extend({enabled:false,events:{"click a":"call"},initialize:function(a){this.workspace=a.workspace;_.bindAll(this,"call","reflect_properties","run_query","swap_axes_on_dropzones","display_drillthrough","clicked_cell_drillthrough_export","clicked_cell_drillthrough","activate_buttons","switch_to_mdx","post_mdx_transform","toggle_fields_action");this.workspace.bind("properties:loaded",this.reflect_properties);this.workspace.trigger("workspace:toolbar:render",{workspace:this.workspace});this.workspace.bind("query:new",this.activate_buttons);this.workspace.bind("query:result",this.activate_buttons)},activate_buttons:function(a){if(a!=null&&a.data&&a.data.cellset&&a.data.cellset.length>0){$(a.workspace.toolbar.el).find(".button").removeClass("disabled_toolbar");$(a.workspace.el).find("td.data").removeClass("cellhighlight").unbind("click");$(a.workspace.el).find(".table_mode").removeClass("on")}else{$(a.workspace.toolbar.el).find(".button").addClass("disabled_toolbar").removeClass("on");$(a.workspace.el).find(".fields_list .disabled_toolbar").removeClass("disabled_toolbar");$(a.workspace.toolbar.el).find(".new, .open, .save, .edit, .run,.auto,.non_empty,.toggle_fields,.toggle_sidebar,.switch_to_mdx, .mdx").removeClass("disabled_toolbar")}this.reflect_properties()},template:function(){var a=$("#template-workspace-toolbar").html()||"";return _.template(a)()},render:function(){$(this.el).html(this.template());return this},call:function(a){a.preventDefault();var b=a.target.hash.replace("#","");if(!$(a.target).hasClass("disabled_toolbar")&&this[b]){this[b](a)}return false},reflect_properties:function(){var a=this.workspace.query.properties?this.workspace.query.properties.properties:Settings.QUERY_PROPERTIES;if(a["saiku.olap.query.nonempty"]==="true"){$(this.el).find(".non_empty").addClass("on")}if(a["saiku.olap.query.automatic_execution"]==="true"){$(this.el).find(".auto").addClass("on")}if(a["saiku.olap.query.drillthrough"]!=="true"){$(this.el).find(".drillthrough, .drillthrough_export").addClass("disabled_toolbar")}if(a["org.saiku.query.explain"]!=="true"){$(this.el).find(".explain_query").addClass("disabled_toolbar")}if(a["org.saiku.connection.scenario"]!=="true"){$(this.el).find(".query_scenario").addClass("disabled_toolbar")}else{$(this.el).find(".query_scenario").removeClass("disabled_toolbar");$(this.el).find(".drillthrough, .drillthrough_export").addClass("disabled_toolbar")}if(a["saiku.olap.query.limit"]=="true"||a["saiku.olap.query.filter"]=="true"){$(this.workspace.el).find(".fields_list_header").addClass("limit")}if(this.workspace.query.get("formatter")!=="undefined"&&this.workspace.query.get("formatter")=="flattened"){if(!$(this.el).find(".group_parents").hasClass("on")){$(this.el).find(".group_parents").addClass("on")}}if($(this.workspace.el).find(".workspace_results tbody.ui-selectable").length>0){$(this.el).find(".zoom_mode").addClass("on")}$(this.el).find(".spark_bar, .spark_line").removeClass("on");$(this.el).find("a.edit").removeClass("disabled_toolbar");if(Settings.MODE=="VIEW"||this.workspace.isReadOnly){$(this.el).find("a.edit").hide()}else{if(this.workspace.viewState=="view"){$(this.el).find("a.edit").removeClass("on")}else{$(this.el).find("a.edit").addClass("on")}$(this.el).find("a.edit").show("normal")}},new_query:function(a){this.workspace.switch_view_state("edit");this.workspace.new_query();return false},edit_query:function(a){$(a.target).toggleClass("on");if($(a.target).hasClass("on")){this.workspace.switch_view_state("edit")}else{this.workspace.switch_view_state("view")}},save_query:function(c){var a=this;if(this.workspace.query){this.workspace.query.properties.update(false);if(typeof this.editor!="undefined"){var b=this.editor.getValue();this.workspace.query.action.post("/mdx",{success:function(e,d){(new SaveQuery({query:a.workspace.query})).render().open()},data:{mdx:b}})}else{(new SaveQuery({query:this.workspace.query})).render().open()}}},open_query:function(a){(new OpenDialog()).render().open()},run_query:function(a){this.workspace.query.run(true)},automatic_execution:function(a){this.workspace.query.properties.toggle("saiku.olap.query.automatic_execution").update();$(a.target).toggleClass("on")},toggle_fields:function(b){var a=this;if(b){$(this.el).find(".toggle_fields").toggleClass("on")}if(!$(this.el).find(".toggle_fields").hasClass("on")){this.toggle_fields_action("hide")}else{this.toggle_fields_action("show")}},toggle_fields_action:function(d,e){var b=this;if(d=="show"&&$(".workspace_editor").is(":visible")){return}else{if(d=="hide"&&$(".workspace_editor").is(":hidden")){return}}if(e){$(".workspace_editor").css("height","");if($(".workspace_editor").is(":hidden")){$(".workspace_editor").show()}else{$(".workspace_editor").hide()}return}var c=$(".workspace_editor").height();if(d=="hide"){var a=$(".workspace_results").height();$(".workspace_results").height(a-c)}$(this.workspace.el).find(".workspace_editor").slideToggle({queue:false,progress:function(){b.workspace.adjust()},complete:function(){if($(".workspace_editor").is(":hidden")){$(".workspace_editor").height(c)}else{$(".workspace_editor").css("height","")}b.workspace.adjust()}})},toggle_sidebar:function(){this.workspace.toggle_sidebar()},group_parents:function(a){$(a.target).toggleClass("on");if($(a.target).hasClass("on")){this.workspace.query.set({formatter:"flattened"});this.workspace.query.setProperty("saiku.ui.formatter","flattened")}else{this.workspace.query.set({formatter:"flat"});this.workspace.query.setProperty("saiku.ui.formatter","flat")}this.workspace.query.run()},non_empty:function(a){this.workspace.query.properties.toggle("saiku.olap.query.nonempty").toggle("saiku.olap.query.nonempty.rows").toggle("saiku.olap.query.nonempty.columns").update();$(a.target).toggleClass("on");this.workspace.query.run()},swap_axis:function(a){$(this.workspace.el).find(".workspace_results table").html("");$(this.workspace.processing).html('<span class="i18n">Swapping axes...</span>');this.workspace.block("Swapping axes...");this.workspace.query.action.put("/swapaxes",{success:this.swap_axes_on_dropzones,error:this.workspace.unblock})},check_modes:function(b){if(typeof b==="undefined"||b==null){return}if($(this.workspace.el).find(".workspace_results tbody.ui-selectable").length>0){$(this.workspace.el).find(".workspace_results tbody").selectable("destroy")}if(!$(b).hasClass("on")){$(this.workspace.el).find("td.data").removeClass("cellhighlight").unbind("click");$(this.workspace.el).find(".table_mode").removeClass("on");this.workspace.query.run()}else{if($(b).hasClass("drillthrough_export")){$(this.workspace.el).find("td.data").addClass("cellhighlight").unbind("click").click(this.clicked_cell_drillthrough_export);$(this.workspace.el).find(".query_scenario, .drillthrough, .zoom_mode").removeClass("on")}else{if($(b).hasClass("drillthrough")){$(this.workspace.el).find("td.data").addClass("cellhighlight").unbind("click").click(this.clicked_cell_drillthrough);$(this.workspace.el).find(".query_scenario, .drillthrough_export, .zoom_mode").removeClass("on")}else{if($(b).hasClass("query_scenario")){this.workspace.query.scenario.activate();$(this.workspace.el).find(".drillthrough, .drillthrough_export, .zoom_mode").removeClass("on")}else{if($(b).hasClass("zoom_mode")){var a=this;$(a.workspace.el).find(".workspace_results tbody").selectable({filter:"td",stop:function(d,e){var c=[];$(a.workspace.el).find(".workspace_results").find("td.ui-selected div").each(function(f,g){var h=$(g).attr("rel");if(h){c.push(h)}});$(a.workspace.el).find(".workspace_results").find(".ui-selected").removeClass(".ui-selected");c=_.uniq(c);if(c.length>0){a.workspace.query.action.put("/zoomin",{success:a.workspace.sync_query,data:{selections:JSON.stringify(c)}})}}});$(this.workspace.el).find(".drillthrough, .drillthrough_export").removeClass("on")}}}}}},query_scenario:function(a){$(a.target).toggleClass("on");this.check_modes($(a.target))},zoom_mode:function(a){$(a.target).toggleClass("on");this.check_modes($(a.target))},drillthrough:function(a){$(a.target).toggleClass("on");this.check_modes($(a.target))},display_drillthrough:function(b,a){this.workspace.table.render({data:a});Saiku.ui.unblock()},export_drillthrough:function(a){$(a.target).toggleClass("on");this.check_modes($(a.target))},clicked_cell_drillthrough_export:function(a){$target=$(a.target).hasClass("data")?$(a.target).find("div"):$(a.target);var b=$target.attr("rel");(new DrillthroughModal({workspace:this.workspace,maxrows:10000,title:"Drill-Through to CSV",action:"export",position:b,query:this.workspace.query})).open()},clicked_cell_drillthrough:function(a){$target=$(a.target).hasClass("data")?$(a.target).find("div"):$(a.target);var b=$target.attr("rel");(new DrillthroughModal({workspace:this.workspace,maxrows:200,title:"Drill-Through",action:"table",success:this.display_drillthrough,position:b,query:this.workspace.query})).open()},swap_axes_on_dropzones:function(b,a){this.workspace.query.parse(a);this.workspace.unblock();this.workspace.sync_query();Saiku.ui.unblock()},show_mdx:function(a){this.workspace.query.action.get("/mdx",{success:function(c,b){(new MDXModal({mdx:b.mdx})).render().open()}})},export_xls:function(a){window.location=Settings.REST_URL+Saiku.session.username+"/query/"+this.workspace.query.id+"/export/xls"},export_csv:function(a){window.location=Settings.REST_URL+Saiku.session.username+"/query/"+this.workspace.query.id+"/export/csv"},export_pdf:function(a){window.location=Settings.REST_URL+Saiku.session.username+"/query/"+this.workspace.query.id+"/export/pdf/"+this.workspace.query.formatter},switch_to_mdx:function(d){var a=this;$(this.workspace.el).find(".workspace_fields").addClass("hide");$(this.el).find(".auto, .query_scenario, .buckets, .non_empty, .swap_axis, .mdx, .switch_to_mdx, .zoom_mode").parent().hide();if($(this.workspace.el).find(".workspace_results tbody.ui-selectable").length>0){$(this.workspace.el).find(".workspace_results tbody").selectable("destroy")}$(this.el).find(".run").attr("href","#run_mdx");$(this.el).find(".run, .save, .open, .new, .edit").removeClass("disabled_toolbar");if(Settings.MODE!="view"&&Settings.MODE!="table"&&!this.workspace.isReadOnly){$mdx_editor=$(this.workspace.el).find(".mdx_input");$(this.workspace.el).find(".workspace_editor .mdx_input, .workspace_editor .editor_info, .workspace_editor").removeClass("hide").show();this.editor=ace.edit("mdx_editor");this.editor.setShowPrintMargin(false);this.editor.setFontSize(11);this.editor.commands.addCommand({name:"runmdx",bindKey:{win:"Ctrl-Enter",mac:"Command-Enter"},exec:function(f){a.run_mdx()},readOnly:true});var b=function(){var f=a.editor.getCursorPosition();$mdx_editor.parent().find(".editor_info").html("&nbsp; "+(f.row+1)+", "+f.column)};this.editor.on("changeSelection",b);b();var e=function(){var i=$(document).height()/3;var f=Math.floor(i/a.editor.renderer.lineHeight);var h=a.editor.getSession().getScreenLength()>f?f:a.editor.getSession().getScreenLength();var g=(h+1)*a.editor.renderer.lineHeight+a.editor.renderer.scrollBar.getWidth();$mdx_editor.height(g.toString()+"px");a.editor.resize();a.workspace.adjust()};var c=function(){var h=a.editor.session;a.editor.resize();h.setUseWrapMode(true);if(h.getUseWrapMode()){var g=a.editor.renderer.characterWidth;var f=a.editor.renderer.scroller.clientWidth;if(f>0){h.setWrapLimitRange(null,parseInt(f/g,10))}}};c();e();a.editor.focus();a.editor.clearSelection();a.editor.getSession().setValue("");a.editor.getSession().on("change",e);$(window).resize(c);a.editor.on("changeSelection",e);a.editor.on("focus",function(f){e();return true});a.editor.on("blur",function(f){if($(a.workspace.el).find(".mdx_input").height()>100){$(a.workspace.el).find(".mdx_input").height(100)}a.editor.resize();a.workspace.adjust();return true});this.editor.getSession().setMode("ace/mode/text")}if(this.workspace.dimension_list&&this.workspace.measure_list){$(this.workspace.el).find(".sidebar_inner ul li a").css({fontWeight:"normal"}).parent("li").removeClass("ui-draggable ui-draggable-disabled ui-state-disabled")}this.activate_buttons({workspace:this.workspace});$(this.workspace.toolbar.el).find(".run").removeClass("disabled_toolbar");$(this.workspace.table.el).empty();this.workspace.adjust();this.post_mdx_transform()},post_mdx_transform:function(){var a=this;this.workspace.query.action.post("/qm2mdx",{success:function(b,c){if(a.editor){a.editor.setValue(c.mdx,0);a.editor.focus();a.editor.clearSelection()}a.workspace.query.parse(c);a.workspace.query.set({type:"MDX",formatter:"flat"});$(a.el).find(".group_parents").removeClass("on")}})},run_mdx:function(b){if($(this.workspace.el).find(".mdx_input").height()>100){$(this.workspace.el).find(".mdx_input").height(100)}this.editor.resize();var a=this.editor.getValue();this.workspace.query.run(true,a)},explain_query:function(c){var a=this;var b=function(e,d){var g="<textarea style='width: "+($("body").width()-165)+"px;height:"+($("body").height()-175)+"px;'>";if(d!=null&&d.error!=null){g+=d.error}else{if(d.cellset&&d.cellset.length===0){g+="Empty explain plan!"}else{g+=d.cellset[1][0].value}}g+="</textarea>";Saiku.ui.unblock();var f=g;var f='<div id="fancy_results" class="workspace_results" style="overflow:visible"><table><tr><th clas=\'row_header\'>Explain Plan</th></tr><tr><td>'+g+"</td></tr></table></div>";$.fancybox(f,{autoDimensions:false,autoScale:false,height:($("body").height()-100),width:($("body").width()-100),transitionIn:"none",transitionOut:"none"})};a.workspace.query.action.get("/explain",{success:b});return false}});var WorkspaceDropZone=Backbone.View.extend({template:function(){var a=$("#template-workspace-dropzones").html()||"";return _.template(a)()},events:{"sortbeforestop .fields_list_body":"select_dimension","click .d_dimension span.selections":"selections","click .d_dimension a":"selections","click .d_measure a":"remove_dimension","click .d_measure span.sort":"sort_measure","click .d_dimension span.sort":"sort_measure","click .limit":"limit_axis","click .clear_axis":"clear_axis"},initialize:function(a){this.workspace=a.workspace;_.bindAll(this,"select_dimension","move_dimension","remove_dimension","update_selections","sort_measure","limit_axis","set_query_axis","set_query_axis_filter","set_query_axis_sort")},render:function(){$(this.el).html(this.template());$(this.el).find(".connectable").sortable({connectWith:$(this.el).find(".connectable"),forcePlaceholderSize:true,forceHelperSize:true,items:"> li",opacity:0.6,placeholder:"placeholder",tolerance:"touch",start:function(a,b){b.placeholder.text(b.helper.text())}});return this},limit_axis:function(d){var c=this;if(typeof this.workspace.query=="undefined"){return false}if(this.workspace.query.get("type")!="QM"||Settings.MODE=="view"){return false}var a=$(d.target).hasClass("limit")?$(d.target):$(d.target).parent();var b=a.siblings(".fields_list_body");var e="";var f="ROWS";if(b.hasClass("rows")){f="ROWS"}if(b.hasClass("columns")){f="COLUMNS"}if(b.hasClass("filter")){f="FILTER"}$body=$(document);$.contextMenu("destroy",".limit");$.contextMenu({appendTo:a,selector:".limit",ignoreRightClick:true,build:function(g,D){var h=c.workspace.query;var q=h.get("schema");var z=h.get("connection")+"/"+h.get("catalog")+"/"+((q==""||q==null)?"null":q)+"/"+h.get("cube");var p={};var u=Saiku.session.sessionworkspace.cube[z].get("data").measures;var i,v,H,y,w,k;var G,j,l;var F=false;var E=false;var B=false;var A=c.workspace.query.get("axes");_.each(A,function(n){if(n.name==f){i=n.limitFunction;v=n.limitFunctionN;H=n.limitFunctionSortLiteral;y=n.filterCondition;B=(n.limitFunction!=null);F=(n.filterCondition!=null);E=(n.sortOrder!=null);w=n.sortOrder;k=n.sortOrderLiteral}});if(i!=null&&H==null){j=i+"###SEPARATOR###"+v}else{if(i!=null&&H!=null&&v!=null){j="custom"}}if(E&&w!=null){G="customsort"}_.each(u,function(n){p[n.uniqueName]={name:n.caption,payload:{n:10,sortliteral:n.uniqueName}}});var r=function(s,n){var t={};for(key in s){t[(n+"###SEPARATOR###"+key)]=_.clone(s[key]);t[(n+"###SEPARATOR###"+key)].fun=n;if(n==i&&H==key&&s[key].payload.n==v){j=n+"Quick";t[(n+"###SEPARATOR###"+key)].name="<b>"+s[key].name+"</b>"}if(n==w&&k==key){G=n+"Quick";t[(n+"###SEPARATOR###"+key)].name="<b>"+s[key].name+"</b>"}}return t};var x={filter:{name:"Filter",items:{customfilter:{name:"Custom..."},clearfilter:{name:"Clear Filter"}}},limit:{name:"Limit",items:{"TopCount###SEPARATOR###10":{name:"Top 10"},"BottomCount###SEPARATOR###10":{name:"Bottom 10"},TopCountQuick:{name:"Top 10 by...",items:r(p,"TopCount")},BottomCountQuick:{name:"Bottom 10 by...",items:r(p,"BottomCount")},customtop:{name:"Custom Limit..."},clearlimit:{name:"Clear Limit"}}},sort:{name:"Sort",items:{ASCQuick:{name:"Ascending",items:r(p,"ASC")},DESCQuick:{name:"Descending",items:r(p,"DESC")},BASCQuick:{name:"Ascending (Breaking Hierarchy)",items:r(p,"BASC")},BDESCQuick:{name:"Descending (Breaking Hierarchy)",items:r(p,"BDESC")},customsort:{name:"Custom..."},clearsort:{name:"Clear Sort"}}}};p["10"]={payload:{n:10}};if(F){var C=x.filter;C.name="<b>"+C.name+"</b>";C.items.customfilter.name="<b>"+C.items.customfilter.name+"</b>"}if(E){var o=x.sort.items;x.sort.name="<b>"+x.sort.name+"</b>";if(G in o){o[G].name="<b>"+o[G].name+"</b>"}}if(B){var m=x.limit.items;x.limit.name="<b>"+x.limit.name+"</b>";if(j in m){m[j].name="<b>"+m[j].name+"</b>"}}return{callback:function(M,N){if(M=="clearfilter"){a.removeClass("on");var s="/axis/"+f+"/filter";c.set_query_axis_filter(f,null);c.workspace.query.action.del(s,{success:c.workspace.query.run})}else{if(M=="customfilter"){var I=function(P){c.set_query_axis_filter(f,P);var O="/axis/"+f+"/filter/";c.workspace.query.action.post(O,{success:c.workspace.query.run,data:{filterCondition:P}})};(new FilterModal({axis:f,success:I,query:c.workspace.query,expression:y,expressionType:"Filter"})).render().open()}else{if(M=="clearlimit"){a.removeClass("on");var s="/axis/"+f+"/limit";c.set_query_axis(f,null,null,"");c.workspace.query.action.del(s,{success:c.workspace.query.run})}else{if(M=="customtop"){var I=function(O,R,Q){c.set_query_axis(f,O,R,Q);var P="/axis/"+f+"/limit/"+O;c.workspace.query.action.post(P,{success:c.workspace.query.run,data:{n:R,sortliteral:Q}})};(new CustomFilterModal({axis:f,measures:u,success:I,query:c.workspace.query,func:i,n:v,sortliteral:H})).render().open()}else{if(M=="customsort"){var t=function(Q,O){c.set_query_axis_sort(f,Q,O);var P="/axis/"+f+"/sort/"+Q+"/"+encodeURIComponent(O);c.workspace.query.action.post(P,{success:c.workspace.query.run})};(new FilterModal({axis:f,success:t,query:c.workspace.query,expression:k,expressionType:"Order"})).render().open()}else{if(M=="clearsort"){a.removeClass("on");var s="/axis/"+f+"/sort";c.set_query_axis_sort(f,null,null);c.workspace.query.action.del(s,{success:c.workspace.query.run})}else{var L=M.split("###SEPARATOR###")[0];var K=M.split("###SEPARATOR###")[1];var n="";var J={};if(_.indexOf(["ASC","BASC","DESC","BDESC"],L)>-1){n="sort";c.set_query_axis_sort(f,L,p[K].payload.sortliteral);L+="/"+encodeURIComponent(p[K].payload.sortliteral)}else{n="limit";c.set_query_axis(f,L,p[K].payload.n,p[K].payload.sortliteral);J=p[K].payload}var s="/axis/"+f+"/"+n+"/"+L;c.workspace.query.action.post(s,{success:c.workspace.query.run,data:J})}}}}}}},items:x}}});a.contextMenu()},set_query_axis_filter:function(d,b){var a=this;var c=this.workspace.query.get("axes");_.each(c,function(e){if(e.name==d){e.filterCondition=b;if(e.limitFunction!=null||e.filterCondition!=null||e.sortOrder!=null){$(a.el).find('.fields_list[title="'+d+'"] .limit').addClass("on")}else{$(a.el).find('.fields_list[title="'+d+'"] .limit').removeClass("on")}return false}});return false},set_query_axis_sort:function(e,c,a){var b=this;var d=this.workspace.query.get("axes");_.each(d,function(f){if(f.name==e){f.sortOrder=c;f.sortOrderLiteral=a;if(f.limitFunction!=null||f.filterCondition!=null||f.sortOrder!=null){$(b.el).find('.fields_list[title="'+e+'"] .limit').addClass("on")}else{$(b.el).find('.fields_list[title="'+e+'"] .limit').removeClass("on")}return false}});return false},set_query_axis:function(e,c,f,b){var a=this;var d=this.workspace.query.get("axes");_.each(d,function(g){if(g.name==e){g.limitFunction=c;g.limitFunctionN=f;g.limitFunctionSortLiteral=b;if(g.limitFunction!=null||g.filterCondition!=null||g.sortOrder!=null){$(a.el).find('.fields_list[title="'+e+'"] .limit').addClass("on")}else{$(a.el).find('.fields_list[title="'+e+'"] .limit').removeClass("on")}return false}});return false},clear_axis:function(e){var c=this;if(typeof this.workspace.query=="undefined"){return false}if(this.workspace.query.get("type")!="QM"||Settings.MODE=="view"){return false}var a=$(e.target);var b=a.siblings(".fields_list_body");var f="";var g="";if(b.hasClass("rows")){g="ROWS"}if(b.hasClass("columns")){g="COLUMNS"}if(b.hasClass("filter")){g="FILTER"}var d="/axis/"+g;c.workspace.query.action.del(d,{success:function(i,h){b.find(".connectable").empty();c.workspace.query.parse(h);c.workspace.sync_query()}});e.preventDefault();return false},sort_measure:function(c,i){var d=$(c.target).parent().parents(".fields_list_body");var a="";var h="ROWS";if(d.hasClass("rows")){a="ROWS";h="COLUMNS"}if(d.hasClass("columns")){a="COLUMNS";h="ROWS"}if(d.hasClass("filter")){a="FILTER";h="COLUMNS"}var e="";if($(c.target).hasClass("none")){e="none"}if($(c.target).hasClass("BASC")){e="BASC"}if($(c.target).hasClass("BDESC")){e="BDESC"}var f=$(c.target).parent().find("a").attr("href").replace("#","").split("/");var g="-";if($(c.target).parent().hasClass("d_dimension")){g=f[2]+".CurrentMember.Name";d.find(".d_dimension .sort").removeClass("BASC").removeClass("BDESC").addClass("none");d.parent().parent().find("."+h.toLowerCase()+" .d_measure .sort").removeClass("BASC").removeClass("BDESC").addClass("none");h=a}else{g=f[f.length-1];d.find(".d_measure .sort").removeClass("BASC").removeClass("BDESC").addClass("none");d.parent().parent().find("."+h.toLowerCase()+" .d_dimension .sort").removeClass("BASC").removeClass("BDESC").addClass("none")}var j="none";if(e=="none"){j="BASC"}if(e=="BASC"){j="BDESC"}if(e=="BDESC"){j="none"}$(c.target).removeClass("none").addClass(j);if(j=="none"){var b="/axis/"+h+"/sort/";this.workspace.query.action.del(b,{success:this.workspace.query.run})}else{var b="/axis/"+h+"/sort/"+j+"/"+g;this.workspace.query.action.post(b,{success:this.workspace.query.run})}},select_dimension:function(c,l){var d=l.item.parents(".fields_list_body");var h="";if(d.hasClass("rows")){h="ROWS"}if(d.hasClass("columns")){h="COLUMNS"}if(d.hasClass("filter")){h="FILTER"}if(l.item.hasClass("d_measure")||l.item.hasClass("d_dimension")){this.move_dimension(c,l,h);return}var b=l.item.find("a").attr("href");var m=$(this.workspace.el).find(".sidebar").find('a[href="'+b+'"]').parent("li").first();m.css({fontWeight:"bold"});m.draggable("disable");m.parents(".parent_dimension").find(".folder_collapsed").css({fontWeight:"bold"});if(l.item.find("a").hasClass("level")){var i=$("<span />").addClass("sprite selections");var j=$("<span />").addClass("sprite sort none");l.item.addClass("d_dimension").prepend(i);j.insertBefore(i)}else{var i=$("<span />").addClass("sort none");l.item.addClass("d_measure").prepend(i)}var f=l.item.find("a").attr("href").replace("#","");var e=f.split("/")[0];var a=[];this.update_selections(c,l);d.find("a").each(function(o,n){var q=$(n).attr("href");var p=q.replace("#","").split("/")[0];if(a.indexOf(p)==-1){a.push(p)}});var g=a.indexOf(e);this.workspace.query.move_dimension(f,h,g,("FILTER"==h));if("FILTER"==h&&l.item.hasClass("d_dimension")){var k={target:d.find('a[href="#'+f+'"]')};this.selections(k,l)}return true},move_dimension:function(d,e,g){if(!e.item.hasClass("deleted")){var a=e.item.parents(".fields_list_body");var f=e.item.find("a").attr("href").replace("#","").split("/")[0];var c=[];this.update_selections(d,e);a.find("a").each(function(j,h){var l=$(h).attr("href");var k=l.replace("#","").split("/")[0];if(c.indexOf(k)==-1){c.push(k)}});var b=c.indexOf(f);this.workspace.query.move_dimension(f,g,b)}d.stopPropagation();return false},update_selections:function(q,j){var a=j.item.find("a").attr("href");var r=a.replace("#","").split("/")[0];var f=j.item.parent(".connectable").children().index(j.item);var g=j.item.parents(".fields_list_body");var l=g.parent().parent();var t="";var p="";var k=this;var o=$(k.workspace.el).find(".sidebar").find('a[href="'+a+'"]').parent();var e=$(j.item);var b=$(j.item).hasClass("d_dimension")?"d_dimension":"d_measure";var d="";if(g.hasClass("rows")){d="ROWS"}if(g.hasClass("columns")){d="COLUMNS"}if(g.hasClass("filter")){d="FILTER"}p=".rows, .columns, .filter";l.find(p).find("a").each(function(u,v){var w=$(v).attr("href").replace("#","");var x=w.split("/")[0];if(x==r&&(("#"+w)!=a)){$(v).parent().remove()}});var i=null;var c=null;var m=$(j.item).prev();if(m&&m.length>0){var s=m.find("a").attr("href");c=s.replace("#","").split("/")[0]}var n=$(j.placeholder).next();while(c!=null&&n&&n.length>0){var h=n.find("a").attr("href");i=h.replace("#","").split("/")[0];if(c==i){n.insertBefore($(j.item))}else{c=null}n=$(j.placeholder).next()}o.parent().find(".ui-draggable-disabled").clone().attr("class","ui-draggable").removeAttr("style").addClass(b).insertAfter(e);g.find(".d_dimension a").each(function(v,w){w=$(w);if(!w.prev()||(w.prev()&&w.prev().length==0)){var u=$("<span />").addClass("sprite sort none");u.insertBefore(w);var u=$("<span />").addClass("sprite selections");u.insertBefore(w)}});g.find(".d_measure a, .d_dimension a").each(function(v,w){w=$(w);if(!w.prev()||(w.prev()&&w.prev().length==0)){if(d!="FILTER"){var u=$("<span />").addClass("sort none");u.insertBefore(w)}}});$(j.item).remove();$(this.workspace.el).find(".fields_list_body").each(function(u,w){var v=$(w);if(v.find("li").length==0){v.siblings(".clear_axis").addClass("hide")}else{v.siblings(".clear_axis").removeClass("hide")}});return false},remove_dimension:function(c,d){var h=d?d.draggable:$(c.target).parent();var g=h.find("a").attr("href");var a=$(this.workspace.el).find(".sidebar").find('a[href="'+g+'"]').parent("li").first();a.draggable("enable").css({fontWeight:"normal"});if(a.parents(".parent_dimension").children().children(".ui-state-disabled").length===0){a.parents(".parent_dimension").find(".folder_collapsed").css({fontWeight:"normal"})}var f="";var e=g.replace("#","");$target_el=h.parent().parent("div.fields_list_body");if($target_el.hasClass("rows")){f="ROWS"}if($target_el.hasClass("columns")){f="COLUMNS"}if($target_el.hasClass("filter")){f="FILTER"}var b="/axis/"+f+"/dimension/"+e;this.workspace.query.action.del(b,{success:this.workspace.query.run,dataType:"text"});h.addClass("deleted").remove();if($target_el.find("li.d_dimension, li.d_measure, li.ui-draggable").length==0){$target_el.siblings(".clear_axis").addClass("hide")}c.stopPropagation();c.preventDefault();return false},selections:function(c,d){var a=$(c.target).hasClass("sprite")?$(c.target).parent().find(".level"):$(c.target);var b=a.attr("href").replace("#","");(new SelectionsModal({target:a,name:a.text(),key:b,workspace:this.workspace})).open();try{c.preventDefault()}catch(f){}return false}});var Table=Backbone.View.extend({tagName:"table",events:{"click th.row":"clicked_cell","click th.col":"clicked_cell"},initialize:function(a){this.workspace=a.workspace;this.renderer=new SaikuTableRenderer();_.bindAll(this,"render","process_data");this.workspace.bind("query:result",this.render)},clicked_cell:function(c){var b=this;if(this.workspace.query.get("type")!="QM"||Settings.MODE=="table"){return false}if($(this.workspace.el).find(".workspace_results.ui-selectable").length>0){$(this.workspace.el).find(".workspace_results").selectable("destroy")}var a=($(c.target).hasClass("row")||$(c.target).hasClass("col"))?$(c.target).find("div"):$(c.target);var d=$(document);$.contextMenu("destroy",".row, .col");$.contextMenu({appendTo:a,selector:".row, .col",ignoreRightClick:true,build:function(g,E){var m=$(E.currentTarget).find("div");var k=$(E.currentTarget).hasClass("rows")?"ROWS":"COLUMNS";var r=m.attr("rel").split(":");var t=parseInt(r[0]);var p=parseInt(r[1]);var j=b.workspace.query.result.lastresult().cellset[t][p];var o=b.workspace.query;var x=o.get("schema");var A=o.get("connection")+"/"+o.get("catalog")+"/"+((x==""||x==null)?"null":x)+"/"+o.get("cube");var F=j.properties.dimension;var D=j.properties.hierarchy;var B=j.properties.level;var C="";var w=JSON.stringify({hierarchy:D,uniquename:B,type:"level",action:"delete"})+","+JSON.stringify({hierarchy:D,uniquename:j.properties.uniquename,type:"member",action:"add"});var f=j.properties.uniquename;var s=[];var v={};var u=Saiku.session.sessionworkspace.cube[A];var q=(u&&u.has("data"))?u.get("data").dimensions:null;if(!q){Saiku.session.sessionworkspace.cube[A].fetch({async:false});q=Saiku.session.sessionworkspace.cube[A].get("data").dimensions}var G={};var y=[];b.workspace.query.action.get("/axis/"+k+"/dimension/"+encodeURIComponent(F),{success:function(e,h){G=h},async:false});_.each(G.selections,function(e){if(_.indexOf(y,e.levelUniqueName)==-1){y.push(e.levelUniqueName)}});_.each(q,function(e){if(e.name==F){_.each(e.hierarchies,function(h){if(h.uniqueName==D){_.each(h.levels,function(l){v[l.name]={name:l.caption,payload:JSON.stringify({hierarchy:D,uniquename:l.uniqueName,type:"level",action:"add"})};if(_.indexOf(y,l.uniqueName)>-1){v[l.name].disabled=true;v["remove-"+l.name]={name:l.caption,payload:JSON.stringify({hierarchy:D,uniquename:l.uniqueName,type:"level",action:"delete"})}}if(l.uniqueName==B){C=l.caption;l_name=l.name}v["keep-"+l.name]=v[l.name];v["include-"+l.name]=JSON.parse(JSON.stringify(v[l.name]));v["keep-"+l.name].payload=w+","+v[l.name].payload})}})}});v.keeponly={payload:w};v.getchildren={payload:f};if(v.hasOwnProperty("remove-"+l_name)&&v.hasOwnProperty("include-"+l_name)){v.showall={payload:v["remove-"+l_name].payload+", "+v["include-"+l_name].payload}}var n=function(h){var e={};for(key in v){if(h!=null&&h.length<key.length&&key.substr(0,h.length)==h){e[key]=v[key]}}return e};var i=m.html();var z={name:{name:"<b>"+i+"</b>",disabled:true},sep1:"---------",keeponly:{name:"Keep Only",payload:w}};if(F!="Measures"){z.getchildren={name:"Show Children",payload:f};z.fold1key={name:"Include Level",items:n("include-")};z.fold2key={name:"Keep and Include Level",items:n("keep-")};z.fold3key={name:"Remove Level",items:n("remove-")};z.filterlevel={name:"Filter Level"};if(v.showall){z.showall={name:"Remove Filters"}}}return{callback:function(H,h){var e="/axis/"+k+"/dimension/"+encodeURIComponent(F);var l=false;if(H.indexOf("filterlevel")>=0){var H=encodeURIComponent(F)+"/hierarchy/"+encodeURIComponent(D)+"/"+encodeURIComponent(B);(new SelectionsModal({target:null,axis:k,name:C,key:H,workspace:b.workspace})).open();return}if(H.indexOf("children")>=0){e="/axis/"+k+"/dimension/"+encodeURIComponent(F)+"/children";l=true}if(l){b.workspace.query.set({formatter:"flat"})}b.workspace.query.action.put(e,{success:b.workspace.sync_query,dataType:"text",data:l?{member:v[H].payload}:{selections:"["+v[H].payload+"]"}})},items:z}}});a.contextMenu()},render:function(a,b){if(typeof a=="undefined"||typeof a.data=="undefined"||($(this.workspace.el).is(":visible")&&!$(this.el).is(":visible"))){return}if(a.data!=null&&a.data.error!=null){return}if(a.data==null||(a.data.cellset&&a.data.cellset.length===0)){return}$(this.el).html("<tr><td>Rendering "+a.data.width+" columns and "+a.data.height+" rows...</td></tr>");if(b===true){this.process_data(a.data)}else{_.delay(this.process_data,0,a.data)}},process_data:function(b){this.workspace.processing.hide();this.workspace.adjust();var a=this.renderer.render(b);$(this.el).html(a);this.post_process()},post_process:function(){if(this.workspace.query.get("type")=="QM"&&Settings.MODE!="view"){$(this.el).find("th.row, th.col").addClass("headerhighlight")}this.workspace.trigger("table:rendered",this)}});var Workspace=Backbone.View.extend({className:"tab_container",events:{"click .sidebar_separator":"toggle_sidebar","change .cubes":"new_query","drop .sidebar":"remove_dimension","drop .workspace_results":"remove_dimension","click .refresh_cubes":"refresh","click .cancel":"cancel"},initialize:function(a){_.bindAll(this,"caption","adjust","toggle_sidebar","prepare","new_query","init_query","update_caption","populate_selections","refresh","sync_query","cancel","cancelled","no_results","error","switch_view_state");_.extend(this,Backbone.Events);this.loaded=false;this.bind("dimensions:loaded",this.populate_selections);this.bind("query:result",this.render_result);this.toolbar=new WorkspaceToolbar({workspace:this});this.toolbar.render();this.querytoolbar=new QueryToolbar({workspace:this});this.querytoolbar.render();this.drop_zones=new WorkspaceDropZone({workspace:this});this.drop_zones.render();this.table=new Table({workspace:this});this.chart=new Chart({workspace:this});this.item={};this.viewState=(a&&a.viewState)?a.viewState:Settings.DEFAULT_VIEW_STATE;this.isReadOnly=(Settings.MODE=="view"||false);if(a&&a.item){this.item=a.item;if(this.item&&this.item.hasOwnProperty("acl")&&_.indexOf(this.item.acl,"WRITE")<0){this.isReadOnly=true;this.viewState="view"}}if(!a||(!a.query&&!a.viewState)){this.viewState="edit"}if(a&&a.query){this.query=a.query;this.query.workspace=this;this.query.save({},{success:this.init_query})}Saiku.session.bind("tab:add",this.prepare)},caption:function(a){if(this.query&&this.query.name){return this.query.name}else{if(this.query&&this.query.get("name")){return this.query.get("name")}}if(a){Saiku.tabs.queryCount++}return"<span class='i18n'>Unsaved query</span> ("+(Saiku.tabs.queryCount)+")"},template:function(){var a=$("#template-workspace").html()||"";return _.template(a)({cube_navigation:Saiku.session.sessionworkspace.cube_navigation})},refresh:function(a){if(a){a.preventDefault()}Saiku.session.sessionworkspace.refresh()},render:function(){$(this.el).html(this.template());this.processing=$(this.el).find(".query_processing");if(this.isReadOnly||Settings.MODE&&(Settings.MODE=="view"||Settings.MODE=="table")){$(this.el).find(".workspace_editor").remove();this.toggle_sidebar();$(this.el).find(".sidebar_separator").remove();$(this.el).find(".workspace_inner").css({"margin-left":0});$(this.el).find(".workspace_fields").remove();$(this.el).find(".sidebar").hide();$(this.toolbar.el).find(".run, .auto, .toggle_fields, .toggle_sidebar,.switch_to_mdx, .new").parent().remove()}else{$(this.el).find(".workspace_editor").append($(this.drop_zones.el));$(this.el).find(".sidebar").droppable({accept:".d_measure, .d_dimension"});$(this.el).find(".workspace_results").droppable({accept:".d_measure, .d_dimension"})}if(Settings.MODE&&Settings.MODE=="table"){$(this.el).find(".workspace_toolbar").remove();$(this.el).find(".query_toolbar").remove()}else{$(this.el).find(".workspace_toolbar").append($(this.toolbar.el));$(this.el).find(".query_toolbar").append($(this.querytoolbar.el))}this.switch_view_state(this.viewState,true);$(this.el).find(".workspace_results").append($(this.table.el));this.chart.render_view();this.tab.bind("tab:select",this.adjust);$(window).resize(this.adjust);Saiku.session.trigger("workspace:new",{workspace:this});return this},clear:function(){$(this.el).find(".workspace_results table,.connectable").html("");$(this.el).find(".workspace_results_info").empty();$(this.chart.el).find("div.canvas").empty();$(this.querytoolbar.el).find("ul.options a.on").removeClass("on");$(this.el).find('.fields_list[title="ROWS"] .limit').removeClass("on");$(this.el).find('.fields_list[title="COLUMNS"] .limit').removeClass("on");Saiku.session.trigger("workspace:clear",{workspace:this})},adjust:function(){var b=$(this.el).find(".sidebar_separator");var c=87;if(Settings.PLUGIN==true||Settings.BIPLUGIN==true){c=2;if(Settings.MODE=="table"){c=-5}}if($("#header").length==0||$("#header").is("hidden")){c=2}b.height($("body").height()-c);$(this.el).find(".sidebar").height($("body").height()-c);$(this.querytoolbar.el).find("div").height($("body").height()-c-10);var a=$(this.el).find(".workspace_editor").is(":hidden")?0:$(this.el).find(".workspace_editor").height();var d=$(this.el).find(".query_processing").is(":hidden")?0:$(this.el).find(".query_processing").height()+62;$(this.el).find(".workspace_results").css({height:$("body").height()-c-$(this.el).find(".workspace_toolbar").height()-$(this.el).find(".workspace_results_info").height()-a-d-20});this.trigger("workspace:adjust",{workspace:this})},toggle_sidebar:function(){$(this.el).find(".sidebar").toggleClass("hide");$(this.toolbar.el).find(".toggle_sidebar").toggleClass("on");var a=$(this.el).find(".sidebar").hasClass("hide")?5:265;$(this.el).find(".workspace_inner").css({"margin-left":a})},prepare:function(){$(this.el).find(".cubes").parent().css({backgroundColor:"#AC1614"}).delay(300).animate({backgroundColor:"#fff"},"slow")},new_query:function(){if(this.query){this.query.destroy();this.query.clear();if(this.query.name){this.query.name=undefined;this.update_caption(true)}this.query.name=undefined}this.clear();this.processing.hide();Saiku.session.trigger("workspace:clear",{workspace:this});this.selected_cube=$(this.el).find(".cubes").val();if(!this.selected_cube){$(this.el).find(".dimension_tree").html("");$(this.el).find(".measure_tree").html("");return false}var c=this.selected_cube.split("/");var a=c[3];for(var b=4;b<c.length;b++){a+="/"+c[b]}this.query=new Query({connection:c[0],catalog:c[1],schema:(c[2]=="null"?"":c[2]),cube:decodeURIComponent(a),formatter:Settings.CELLSET_FORMATTER},{workspace:this});this.query.save({},{async:false});this.init_query()},init_query:function(a){var b=this;try{var c=this.query.properties?this.query.properties.properties:{};var i=("RENDER_MODE" in Settings)?Settings.RENDER_MODE:("saiku.ui.render.mode" in c)?c["saiku.ui.render.mode"]:null;var d=("RENDER_TYPE" in Settings)?Settings.RENDER_TYPE:("saiku.ui.render.type" in c)?c["saiku.ui.render.type"]:null;if(typeof i!="undefined"&&i!=null){this.querytoolbar.switch_render(i)}if("chart"==i){$(this.chart.el).find(".canvas_wrapper").hide();this.chart.renderer.switch_chart(d);$(this.querytoolbar.el).find('ul.chart [href="#'+d+'"]').parent().siblings().find(".on").removeClass("on");$(this.querytoolbar.el).find('ul.chart [href="#'+d+'"]').addClass("on")}else{if("table"==i&&d in this.querytoolbar){this.querytoolbar.render_mode="table";this.querytoolbar.spark_mode=d;$(this.querytoolbar.el).find("ul.table a."+d).addClass("on")}}}catch(g){if(typeof console!="undefined"){console.log(g)}}if((Settings.MODE=="table")&&this.query){this.query.run(true);return}if(this.query.get("type")=="MDX"){this.query.set({formatter:"flat"});if(!$(this.el).find(".sidebar").hasClass("hide")){this.toggle_sidebar()}$(this.el).find(".workspace_fields").addClass("hide");this.toolbar.switch_to_mdx()}else{$(this.el).find(".workspace_editor").removeClass("hide").show();$(this.el).find(".workspace_fields").removeClass("disabled").removeClass("hide");$(this.el).find(".workspace_editor .mdx_input").addClass("hide");$(this.el).find(".workspace_editor .editor_info").addClass("hide");$(this.toolbar.el).find(".auto, .toggle_fields, .query_scenario, .buckets, .non_empty, .swap_axis, .mdx, .switch_to_mdx, .zoom_mode").parent().show();$(this.el).find(".run").attr("href","#run_query")}this.adjust();this.switch_view_state(this.viewState,true);if(!$(this.el).find(".sidebar").hasClass("hide")&&(Settings.MODE=="table"||Settings.MODE=="view"||this.isReadOnly)){this.toggle_sidebar()}if((Settings.MODE=="view")&&this.query||this.isReadOnly){this.query.run(true);return}if(this.selected_cube===undefined){var f=this.query.get("schema");this.selected_cube=this.query.get("connection")+"/"+this.query.get("catalog")+"/"+((f==""||f==null)?"null":f)+"/"+this.query.get("cube");$(this.el).find(".cubes").val(this.selected_cube)}if(this.selected_cube){var h=Saiku.session.sessionworkspace.cube[this.selected_cube];this.dimension_list=new DimensionList({workspace:this,dimension:h,type:"dimensions"});$(this.el).find(".dimension_tree").html("").append($(this.dimension_list.el));this.measure_list=new DimensionList({workspace:this,dimension:h,type:"measures"});$(this.el).find(".measure_tree").html("").append($(this.measure_list.el));if(!h.has("data")){h.fetch({success:function(){b.trigger("cube:loaded")}})}}else{$(this.el).find(".dimension_tree").html("");$(this.el).find(".measure_tree").html("")}if(typeof a!="undefined"){this.query.run(true)}},sync_query:function(c){var a=this;var d=function(){if(!a.isReadOnly&&(!Settings.hasOwnProperty("MODE")||(Settings.MODE!="table"&&Settings.MODE!="view"))){$(a.el).find(".fields_list_body ul").empty();$(a.dimension_list.el).find(".parent_dimension a.folder_collapsed").removeAttr("style");$(a.dimension_list.el).find(".parent_dimension ul li").not(".hierarchy").draggable("enable").css({fontWeight:"normal"});$(a.measure_list.el).find("a.measure").parent().not(".hierarchy").draggable("enable").css({fontWeight:"normal"});$(a.el).find('.fields_list[title="ROWS"] .limit').removeClass("on");$(a.el).find('.fields_list[title="COLUMNS"] .limit').removeClass("on");a.populate_selections(a.measure_list.el);$(a.el).find(".fields_list_body ul li").removeClass("ui-draggable-disabled ui-state-disabled").css({fontWeight:"normal"});$(a.el).find(".fields_list_body").each(function(f,g){var e=$(g);if(e.find("li").length==0){e.siblings(".clear_axis").addClass("hide")}else{e.siblings(".clear_axis").removeClass("hide")}})}a.query.run()};if(typeof c=="undefined"){d()}else{var b=a.query.get("formatter");a.query.clear();a.query.set({formatter:b});a.query.fetch({success:d})}},populate_selections:function(t){var l=this;if(this.other_dimension){var o=this.query?this.query.get("axes"):false;if(o){for(var f=0;f<o.length;f++){var c=o[f];var g=$(this.el).find("."+c.name.toLowerCase()+" ul");if((c.filterCondition!=null)||(c.limitFunction&&c.limitFunction!=null&&c.limitFunction!="")||(c.sortOrder!=null)){g.parent().siblings(".fields_list_header").addClass("on")}for(var i=0;i<c.dimensionSelections.length;i++){var r=c.dimensionSelections[i];var e=[];var s={};if(r.name!="Measures"&&r.selections.length>0){var m=Saiku.session.sessionworkspace.cube[this.selected_cube].get("data").dimensions;var p=r.selections[0].hierarchyUniqueName;_.each(m,function(h){if(r.name==h.name){_.each(h.hierarchies,function(w){if(w.uniqueName==p){var x=[];_.each(w.levels,function(y){x.push(y.uniqueName)});r.selections=_.sortBy(r.selections,function(y){return _.indexOf(x,y.levelUniqueName)})}})}})}else{if(r.name=="Measures"&&r.selections.length>0){var n=Saiku.session.sessionworkspace.cube[this.selected_cube].get("data").measures;var b=[];_.each(n,function(h){b.push(h.uniqueName)});r.selections=_.sortBy(r.selections,function(h){return _.indexOf(b,h.uniqueName)})}}for(var k=0;k<r.selections.length;k++){var v=r.selections[k];var d,u;if(v.dimensionUniqueName=="Measures"){d="measure";u=v.uniqueName}else{d="dimension";u=v.levelUniqueName}if(e.indexOf(u)===-1){var a=$("");if(typeof t!="undefined"&&(!a.html()||a.html()==null)){a=$(t).find('a[rel="'+u+'"]').parent()}if(typeof l.measure_list!="undefined"&&(!a.html()||a.html()==null)){a=$(l.measure_list.el).find('a[rel="'+u+'"]').parent()}if(typeof l.dimension_list!="undefined"&&(!a.html()||a.html()==null)){a=$(l.dimension_list.el).find('a[rel="'+u+'"]').parent()}var j=a.clone().addClass("d_"+d).appendTo(g);if(d=="dimension"){$("<span />").addClass("sprite selections").prependTo(j);$icon=$("<span />").addClass("sort");var q=false;_.each(o,function(h){if(h.sortLiteral&&h.sortLiteral!=null&&h.sortLiteral.indexOf(v.hierarchyUniqueName)!=-1){$icon.addClass(h.sortOrder);q=true}});if(!q){$icon.addClass("none")}$icon.insertBefore(j.find("span"))}if(d=="measure"){$icon=$("<span />").addClass("sort");var q=false;_.each(o,function(h){if(h.sortLiteral&&h.sortLiteral!=null&&h.sortLiteral.indexOf(u)!=-1){$icon.addClass(h.sortOrder);q=true}});if(!q){$icon.addClass("none")}$icon.insertBefore(j.find("a"))}a.css({fontWeight:"bold"}).draggable("disable").parents(".parent_dimension").find(".folder_collapsed").css({fontWeight:"bold"});e.push(u)}}}}}this.trigger("query:new",{workspace:this});this.query.bind("query:save",this.update_caption)}else{this.other_dimension=t}},update_caption:function(a){var b=this.caption(a);this.tab.set_caption(b)},remove_dimension:function(a,b){if(this.query.get("type")=="QM"){this.drop_zones.remove_dimension(a,b)}},render_result:function(c){$(this.el).find(".workspace_results_info").empty();if(c.data!=null&&c.data.error!=null){return this.error(c)}if(c.data==null||(c.data.cellset&&c.data.cellset.length===0)){return this.no_results(c)}var a=new Date().getHours();if(a<10){a="0"+a}var f=new Date().getMinutes();if(f<10){f="0"+f}var b=a+":"+f;var d=c.data.runtime!=null?(c.data.runtime/1000).toFixed(2):"";var e='<b><span class="i18n">Info:</span></b> &nbsp;'+b+"&emsp;/ &nbsp;"+c.data.width+" x "+c.data.height+"&nbsp; / &nbsp;"+d+"s";$(this.el).find(".workspace_results_info").html(e);this.adjust();return},switch_view_state:function(c,b){var a=c||"edit";if(a=="edit"){this.toolbar.toggle_fields_action("show",b);if(this.query&&this.query.get("type")=="MDX"){this.toolbar.editor.gotoLine(0)}if($(this.el).find(".sidebar").hasClass("hide")){this.toggle_sidebar()}$(this.toolbar.el).find(".auto, .toggle_fields, .toggle_sidebar,.switch_to_mdx, .new").parent().css({display:"block"})}else{if(a=="view"){this.toolbar.toggle_fields_action("hide",b);if(!$(this.el).find(".sidebar").hasClass("hide")){this.toggle_sidebar()}$(this.toolbar.el).find(".auto, .toggle_fields, .toggle_sidebar,.switch_to_mdx").parent().hide()}}this.viewState=a},block:function(a){$(this.el).block({message:'<span class="saiku_logo" style="float:left">&nbsp;&nbsp;</span> '+a});Saiku.i18n.translate()},unblock:function(){if(isIE){Saiku.ui.unblock()}else{$(this.el).unblock();Saiku.ui.unblock()}},cancel:function(b){var a=this;this.query.action.del("/result",{success:function(){a.cancelled()}})},cancelled:function(a){this.processing.html('<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">Canceling Query...</span>').show()},no_results:function(a){this.processing.html('<span class="i18n">No Results</span>').show()},error:function(a){this.processing.html(safe_tags_replace(a.data.error)).show()}});var DeleteRepositoryObject=Modal.extend({type:"delete",buttons:[{text:"Yes",method:"del"},{text:"No",method:"close"}],initialize:function(a){this.options.title="Confirm deletion";this.query=a.query;this.success=a.success;this.message=_.template("Are you sure you want to delete <%= name %>?")({name:this.query.get("name")})},del:function(){this.query.id=_.uniqueId("query_");this.query.url=this.query.url()+"?file="+encodeURIComponent(this.query.get("file"));this.query.destroy({success:this.success,dataType:"text",error:this.error});this.close()},error:function(){$(this.el).find("dialog_body").html("Could not delete repository object")}});var OpenQuery=Backbone.View.extend({className:"tab_container",events:{"click .query":"view_query","dblclick .query":"select_and_open_query","click .add_folder":"add_folder","click li.folder":"toggle_folder","click .workspace_toolbar a.button":"prevent_default","click .workspace_toolbar a.open":"open_query","click .workspace_toolbar a.edit":"edit_query","click .workspace_toolbar [href=#edit_folder]":"edit_folder","click .workspace_toolbar [href=#delete_folder]":"delete_repoObject","click .workspace_toolbar [href=#delete_query]":"delete_repoObject","click .workspace_toolbar [href=#edit_permissions]":"edit_permissions","click .queries":"click_canvas","keyup .search_file":"search_file","click .cancel_search":"cancel_search"},template:function(){return _.template($("#template-open-dialog").html())()},template_repository_objects:function(b){var a=this;$(this.el).find(".sidebar ul").html(_.template($("#template-repository-objects").html())({repoObjects:b}))},caption:function(){return"Repository"},render:function(){$(this.el).html(this.template());this.tab.bind("tab:select",this.fetch_queries);this.tab.bind("tab:select",this.adjust);$(window).resize(this.adjust);var a=this;$.contextMenu("destroy","li.query, div.folder_row");$.contextMenu({selector:"li.query, div.folder_row",events:{show:function(b){$(a.el).find(".selected").removeClass("selected");$(this).addClass("selected");var d=$(this).find("a").attr("href").replace("#","");var c=a.queries[d];if(typeof c.acl!="undefined"&&_.indexOf(c.acl,"WRITE")<0){b.commands["delete"].disabled=true;b.items["delete"].disabled=true;b.commands.edit.disabled=true;b.items.edit.disabled=true}else{b.commands["delete"].disabled=false;b.items["delete"].disabled=false;b.commands.edit.disabled=false;b.items.edit.disabled=false}if($(this).hasClass("folder_row")){b.commands.open.disabled=true;b.items.open.disabled=true}else{b.commands.open.disabled=false;b.items.open.disabled=false}}},callback:function(c,b){var e=$(this).find("a").attr("href").replace("#","");var d=a.queries[e];a.selected_query=new SavedQuery({file:e,name:d.name,type:d.type});if(c=="open"&&$(this).hasClass("query")){a.open_query()}if(c=="edit"&&$(this).hasClass("query")){a.edit_query()}else{if(c=="new"){a.add_folder()}else{if(c=="delete"){a.delete_repoObject()}}}},items:{open:{name:"<span class='i18n'>Open</span>"},edit:{name:"<span class='i18n'>Edit</span>"},"delete":{name:"<span class='i18n'>Delete</span>"},sep1:"---------","new":{name:"<span class='i18n'>New Folder</span>"}}});return this},initialize:function(a){_.bindAll(this,"adjust","fetch_queries","clear_query","select_and_open_query","cancel_search","add_folder");this.repository=new Repository({},{dialog:this})},fetch_queries:function(){this.repository.fetch()},populate:function(c){var a=this;a.template_repository_objects(c);a.queries={};function b(d){_.forEach(d,function(e){a.queries[e.path]=e;if(e.type==="FOLDER"){b(e.repoObjects)}})}b(c)},search_file:function(b){var a=$(this.el).find(".search_file").val().toLowerCase();var c=(typeof a=="undefined"||a==""||a==null);if(c||b.which==27||b.which==9){this.cancel_search()}else{if($(this.el).find(".search_file").val()){$(this.el).find(".cancel_search").show()}else{$(this.el).find(".cancel_search").hide()}$(this.el).find("li.query").removeClass("hide");$(this.el).find("li.query a").each(function(d){if($(this).text().toLowerCase().indexOf(a)==-1){$(this).parent("li.query").addClass("hide")}});$(this.el).find("li.folder").addClass("hide");$(this.el).find("li.query").not(".hide").parents("li.folder").removeClass("hide");$(this.el).find("li.folder .folder_row").find(".sprite").removeClass("collapsed");$(this.el).find("li.folder .folder_content").removeClass("hide")}return false},cancel_search:function(a){$(this.el).find("input.search_file").val("");$(this.el).find(".cancel_search").hide();$(this.el).find("li.query, li.folder").removeClass("hide");$(this.el).find(".folder_row").find(".sprite").addClass("collapsed");$(this.el).find("li.folder .folder_content").addClass("hide");$(this.el).find(".search_file").val("").focus();$(this.el).find(".cancel_search").hide()},view_query:function(a){a.preventDefault();var n=$(a.currentTarget);var d=n.find("a");this.unselect_current_selected();n.addClass("selected");var m=d.attr("href").replace("#","");var b=d.text();var j=this.queries[m];$(this.el).find(".workspace_toolbar").removeClass("hide");$(this.el).find(".for_queries").addClass("hide");$(this.el).find(".for_folder").addClass("hide");$(this.el).find(".add_folder").parent().addClass("hide");if(typeof j.acl!="undefined"&&_.indexOf(j.acl,"READ")>-1){$(this.el).find(".for_queries .open").parent().removeClass("hide")}if(typeof j.acl!="undefined"&&_.indexOf(j.acl,"WRITE")>-1){$(this.el).find(".for_queries .delete").parent().removeClass("hide")}if(typeof j.acl!="undefined"&&_.indexOf(j.acl,"GRANT")>-1){$(this.el).find(".for_queries .edit_permissions").parent().removeClass("hide")}try{var h=m.split("/");if(h.length>1){var g=h.splice(0,h.length-1).join("/");var c=this.queries[g];if(typeof c.acl!="undefined"&&_.indexOf(c.acl,"WRITE")>-1){$(this.el).find(".add_folder").parent().removeClass("hide")}}else{if(h.length==1){$(this.el).find(".add_folder").parent().removeClass("hide")}}}catch(i){}var l=$(this.el).find(".workspace_results").html("<h3><strong>"+j.name+"</strong></h3>");var f=$('<ul id="query_info" />').appendTo(l);for(var k in j){if(j.hasOwnProperty(k)&&k!="name"){f.append($("<li />").html("<strong>"+k+"</strong> : "+j[k]))}}this.selected_query=new SavedQuery({file:m,name:b,type:j.type});return false},view_folder:function(d){var a=$(d.currentTarget).children("div").children("a");var e=a.attr("href").replace("#","");var b=a.text();var c=this.queries[e];$(this.el).find(".workspace_toolbar").removeClass("hide");$(this.el).find(".add_folder").parent().addClass("hide");$(this.el).find(".for_queries").addClass("hide");$(this.el).find(".for_folder").addClass("hide");if(typeof c.acl!="undefined"&&_.indexOf(c.acl,"WRITE")>-1){$(this.el).find(".for_folder .delete").parent().removeClass("hide");$(this.el).find(".add_folder").parent().removeClass("hide")}if(typeof c.acl!="undefined"&&_.indexOf(c.acl,"GRANT")>-1){$(this.el).find(".for_folder .edit_permissions").parent().removeClass("hide")}$(this.el).find(".workspace_results").html("<h3><strong>"+b+"</strong></h3>");this.selected_query=new SavedQuery({file:e,name:b,type:c.type})},prevent_default:function(a){a.preventDefault();return false},add_folder:function(b){$selected=$(this.el).find(".selected");var d="";if(typeof $selected!=="undefined"&&$selected){if($selected.hasClass("folder_row")){d=$selected.children("a").attr("href");d=d.length>1?d.substring(1,d.length):d;d+="/"}else{if($selected.hasClass("query")&&!$selected.parent().hasClass("RepositoryObjects")){var c=$selected.find("a");d=c.attr("href");var a=c.text();d=d.substring(1,d.length-a.length)}}}(new AddFolderModal({path:d,success:this.clear_query})).render().open();return false},click_canvas:function(b){var a=$(b.currentTarget);if(a.hasClass("sidebar")){$(this.el).find(".selected").removeClass("selected")}$(this.el).find(".add_folder").parent().removeClass("hide");return false},toggle_folder:function(c){var b=$(c.currentTarget);this.unselect_current_selected();b.children(".folder_row").addClass("selected");var a=b.children(".folder_content");var d=b.children(".folder_row").find(".sprite").hasClass("collapsed");if(d){b.children(".folder_row").find(".sprite").removeClass("collapsed");a.removeClass("hide")}else{b.children(".folder_row").find(".sprite").addClass("collapsed");a.addClass("hide")}this.view_folder(c);return false},select_and_open_query:function(c){var a=$(c.currentTarget).find("a");var d=a.attr("href").replace("#","");var b=a.text();this.selected_query=new SavedQuery({file:d,name:d});this.open_query()},open_query:function(a){Saiku.ui.block("Opening query...");var c=this.queries[this.selected_query.get("file")];var f=_.extend({file:this.selected_query.get("file"),formatter:Settings.CELLSET_FORMATTER},Settings.PARAMS);var e=new Query(f,{name:this.selected_query.get("name")});var d=a;var b=Saiku.tabs.add(new Workspace({query:e,item:c,viewState:d}));return false},edit_query:function(){this.open_query("edit")},delete_repoObject:function(a){(new DeleteRepositoryObject({query:this.selected_query,success:this.clear_query})).render().open();return false},edit_folder:function(a){alert("todo: edit folder properties/permissions");return false},edit_permissions:function(a){(new PermissionsModal({workspace:this.workspace,title:"<span class='i18n'>Permissions</span>",file:this.selected_query.get("file")})).open()},clear_query:function(){$(this.el).find(".workspace_toolbar").addClass("hide");$(this.el).find(".workspace_results").html("");this.fetch_queries()},adjust:function(){$separator=$(this.el).find(".sidebar_separator");$separator.height($("body").height()-87);$(this.el).find(".sidebar").css({width:300,height:$("body").height()-87});$(this.el).find(".workspace_inner").css({"margin-left":305});$(this.el).find(".workspace").css({"margin-left":-305});$(this.el).find(".workspace_results").css({width:$(document).width()-$(this.el).find(".sidebar").width()-30,height:$(document).height()-$("#header").height()-$(this.el).find(".workspace_toolbar").height()-$(this.el).find(".workspace_fields").height()-40})},toggle_sidebar:function(){$(this.el).find(".sidebar").toggleClass("hide");var a=$(this.el).find(".sidebar").hasClass("hide")?5:265;$(this.el).find(".workspace_inner").css({"margin-left":a})},unselect_current_selected:function(){$(this.el).find(".selected").removeClass("selected")}});var SaveQuery=Modal.extend({type:"save",closeText:"Save",events:{click:"select_root_folder","click .dialog_footer a":"call","submit form":"save","click .query":"select_name","click li.folder":"toggle_folder","keyup .search_file":"search_file","click .cancel_search":"cancel_search"},buttons:[{text:"Save",method:"save"},{text:"Cancel",method:"close"}],folder_name:null,file_name:null,initialize:function(c){var a=this;var b="";var d="";if(c.query.name){var d=c.query.name;var e=c.query.name.split("/");b=e[e.length-1];this.file_name=b;if(e.length>1){this.folder_name=e.splice(0,e.length-1).join("/")}}this.query=c.query;this.message=_.template("<div style=\"height:25px; line-height:25px;\"><b><span class=\"i18n\">Search:</span></b> &nbsp; <span class=\"search\"><input type=\"text\" class=\"search_file\"></input><span class=\"cancel_search\"></span></span></div><form id='save_query_form'><div class='RepositoryObjects'><span class='i18n'>Loading...</span></div><br /><label for='name' class='i18n'>File:</label>&nbsp;<input type='text' name='name' value='<%= name %>' /> <span class='save sprite'></span></form>")({name:d});_.extend(this.options,{title:"Save query"});this.repository=new Repository({},{dialog:this});this.bind("open",function(){var f=($("body").height()/2)+($("body").height()/6);if(f>420){f=420}$(this.el).find(".RepositoryObjects").height(f);$(this.el).dialog("option","position","center");$(this.el).parents(".ui-dialog").css({width:"550px"});a.repository.fetch()});_.bindAll(this,"copy_to_repository","close","toggle_folder","select_name","populate","set_name","cancel_search");if(isIE&&isIE<9){$(this.el).find("form").on("submit",this.save)}},populate:function(a){$(this.el).find(".RepositoryObjects").html(_.template($("#template-repository-objects").html())({repoObjects:a}))},select_root_folder:function(b){var a=$(b.target).attr("name")==="name";if(!a){this.unselect_current_selected_folder()}},toggle_folder:function(d){var c=$(d.currentTarget);this.unselect_current_selected_folder();c.children(".folder_row").addClass("selected");var b=c.find("a").attr("href").replace("#","");this.set_name(b,null);var a=c.children(".folder_content");var e=c.children(".folder_row").find(".sprite").hasClass("collapsed");if(e){c.children(".folder_row").find(".sprite").removeClass("collapsed");a.removeClass("hide")}else{c.children(".folder_row").find(".sprite").addClass("collapsed");a.addClass("hide")}return false},set_name:function(c,b){if(c!=null){this.folder_name=c;var a=(this.folder_name!=null?this.folder_name+"/":"")+(this.file_name!=null?this.file_name:"");$(this.el).find('input[name="name"]').val(a)}if(b!=null){$(this.el).find('input[name="name"]').val(b)}},search_file:function(b){var a=$(this.el).find(".search_file").val().toLowerCase();var c=(typeof a=="undefined"||a==""||a==null);if(c||b.which==27||b.which==9){this.cancel_search()}else{if($(this.el).find(".search_file").val()){$(this.el).find(".cancel_search").show()}else{$(this.el).find(".cancel_search").hide()}$(this.el).find("li.query").removeClass("hide");$(this.el).find("li.query a").filter(function(d){return $(this).text().toLowerCase().indexOf(a)==-1}).parent().addClass("hide");$(this.el).find("li.folder").addClass("hide");$(this.el).find("li.query").not(".hide").parents("li.folder").removeClass("hide");$(this.el).find("li.folder .folder_row").find(".sprite").removeClass("collapsed");$(this.el).find("li.folder .folder_content").removeClass("hide")}return false},cancel_search:function(a){$(this.el).find("input.search_file").val("");$(this.el).find(".cancel_search").hide();$(this.el).find("li.query, li.folder").removeClass("hide");$(this.el).find(".folder_row").find(".sprite").addClass("collapsed");$(this.el).find("li.folder .folder_content").addClass("hide");$(this.el).find(".search_file").val("").focus();$(this.el).find(".cancel_search").hide()},select_name:function(c){var a=$(c.currentTarget);this.unselect_current_selected_folder();a.parent().parent().has(".folder").children(".folder_row").addClass("selected");var b=a.find("a").attr("href").replace("#","");this.set_name(null,b);return false},unselect_current_selected_folder:function(){$(this.el).find(".selected").removeClass("selected")},save:function(c){var a="";var b=$(this.el).find('input[name="name"]').val();if(b!=null&&b.length>0){this.query.set({name:b,folder:a});this.query.trigger("query:save");this.query.action.get("/xml",{success:this.copy_to_repository})}else{alert("You need to enter a name!")}c.preventDefault();return false},copy_to_repository:function(d,b){var a=this;var f=this.query.get("folder");var e=this.query.get("name");e=e.length>6&&e.indexOf(".saiku")==e.length-6?e:e+".saiku";e=f+e;var c=function(h,i,g){if(i&&i.status==403&&i.responseText){alert(i.responseText)}else{a.close()}return true};(new SavedQuery({name:this.query.get("name"),file:e,content:b.xml})).save({},{success:this.close,error:c})}});var OpenDialog=Modal.extend({type:"save",closeText:"Open",events:{click:"select_root_folder","click .dialog_footer a":"call","click .query":"select_name","dblclick .query":"open_query","click li.folder":"toggle_folder","keyup .search_file":"search_file","click .cancel_search":"cancel_search","click .export_btn":"export_zip","change .file":"select_file"},buttons:[{id:"test",text:"Open",method:"open_query"},{text:"Cancel",method:"close"}],initialize:function(c){var a=this;var b="";this.message='<div style="height:25px; line-height:25px;"><b><span class="i18n">Search:</span></b> &nbsp; <span class="search"><input type="text" class="search_file"></input><span class="cancel_search"></span></span></div><div class=\'RepositoryObjects\'>Loading....</div><br><b><div class=\'query_name\'><span class=\'i18n\'>Please select a file.....</span></div></b><br><br>';if(Settings.ALLOW_IMPORT_EXPORT){this.message+="<span class='export_zip'> </span> <b><span class='i18n'>Import or Export Files for Folder</span>: </b> <span class='i18n zip_folder'>< Select Folder... ></span> &nbsp; <input type='submit' value='Export' class='export_btn' disabled /><br/><br /><br /><form id='importForm' target='_blank' method='POST' enctype='multipart/form-data'><input type='hidden' name='directory' class='directory'/><input type='file' name='file' class='file'/><input type='submit' value='Import' class='import_btn' disabled /></form>"}_.extend(this.options,{title:"Open"});this.selected_folder=null;this.repository=new Repository({},{dialog:this});this.bind("open",function(){var d=($("body").height()/2)+($("body").height()/6);if(d>420){d=420}$(this.el).find(".RepositoryObjects").height(d);$(this.el).dialog("option","position","center");$(this.el).parents(".ui-dialog").css({width:"550px"});$(this.el).find(".dialog_footer").find('a[href="#open_query"]').hide();a.repository.fetch()});_.bindAll(this,"close","toggle_folder","select_name","populate","cancel_search","export_zip","select_folder","select_file")},populate:function(c){var a=this;$(this.el).find(".RepositoryObjects").html(_.template($("#template-repository-objects").html())({repoObjects:c}));a.queries={};function b(d){_.forEach(d,function(e){a.queries[e.path]=e;if(e.type==="FOLDER"){b(e.repoObjects)}})}b(c)},select_root_folder:function(b){var a=$(b.target).attr("name")==="name";if(!a){this.unselect_current_selected_folder()}},toggle_folder:function(c){var b=$(c.currentTarget);this.unselect_current_selected_folder();b.children(".folder_row").addClass("selected");var a=b.children(".folder_content");var d=b.children(".folder_row").find(".sprite").hasClass("collapsed");if(d){b.children(".folder_row").find(".sprite").removeClass("collapsed");a.removeClass("hide")}else{b.children(".folder_row").find(".sprite").addClass("collapsed");a.addClass("hide")}this.select_folder();return false},select_name:function(c){var a=$(c.currentTarget);this.unselect_current_selected_folder();a.parent().parent().has(".folder").children(".folder_row").addClass("selected");var b=a.find("a").attr("href");b=b.replace("#","");$(this.el).find(".query_name").html(b);$(this.el).find(".dialog_footer").find('a[href="#open_query"]').show();this.select_folder();return false},unselect_current_selected_folder:function(){$(this.el).find(".selected").removeClass("selected")},search_file:function(b){var a=$(this.el).find(".search_file").val().toLowerCase();var c=(typeof a=="undefined"||a==""||a==null);if(c||b.which==27||b.which==9){this.cancel_search()}else{if($(this.el).find(".search_file").val()){$(this.el).find(".cancel_search").show()}else{$(this.el).find(".cancel_search").hide()}$(this.el).find("li.query").removeClass("hide");$(this.el).find("li.query a").filter(function(d){return $(this).text().toLowerCase().indexOf(a)==-1}).parent().addClass("hide");$(this.el).find("li.folder").addClass("hide");$(this.el).find("li.query").not(".hide").parents("li.folder").removeClass("hide");$(this.el).find("li.folder .folder_row").find(".sprite").removeClass("collapsed");$(this.el).find("li.folder .folder_content").removeClass("hide")}return false},cancel_search:function(a){$(this.el).find("input.search_file").val("");$(this.el).find(".cancel_search").hide();$(this.el).find("li.query, li.folder").removeClass("hide");$(this.el).find(".folder_row").find(".sprite").addClass("collapsed");$(this.el).find("li.folder .folder_content").addClass("hide");$(this.el).find(".search_file").val("").focus();$(this.el).find(".cancel_search").hide()},export_zip:function(c){var b=this.selected_folder;if(typeof b!="undefined"&&b!=""){var a=Settings.REST_URL+(new RepositoryZipExport({directory:b})).url();window.open(a+"?directory="+b)}},select_folder:function(){var d=$(this.el).find(".selected");var b=d.length>0?d.children("a").attr("href").replace("#",""):null;if(typeof b!="undefined"&&b!=null&&b!=""){var c=$("#importForm");c.find(".directory").val(b);var a=Settings.REST_URL+(new RepositoryZipExport()).url()+"upload";c.attr("action",a);$(this.el).find(".zip_folder").text(b);this.selected_folder=b;$(this.el).find(".export_btn, .import_btn").removeAttr("disabled");this.select_file()}else{$(this.el).find(".import_btn, .export_btn").attr("disabled","true")}},select_file:function(){var b=$("#importForm");var a=b.find(".file").val();if(typeof a!="undefined"&&a!=""&&a!=null&&this.selected_folder!=null){$(this.el).find(".import_btn").removeAttr("disabled")}else{$(this.el).find(".import_btn").attr("disabled","true")}},open_query:function(f){var a=$(f.currentTarget);var b=$(this.el).find(".query_name").html();if(a.hasClass("query")){b=a.find("a").attr("href").replace("#","")}var d=new SavedQuery({file:b});this.close();Saiku.ui.block("Opening query...");var e=this.queries[b];var h=_.extend({file:b,formatter:Settings.CELLSET_FORMATTER},Settings.PARAMS);var g=new Query(h,{name:b});var c=Saiku.tabs.add(new Workspace({query:g,item:e}));f.preventDefault();return false}});var repoPathUrl=function(){return(Settings.BIPLUGIN5?"/repository":(Settings.BIPLUGIN?"/pentahorepository2":"/repository2"))};var RepositoryObject=Backbone.Model.extend({url:function(){var a=repoPathUrl()+"/resource";return encodeURI(Saiku.session.username+a)}});var RepositoryAclObject=Backbone.Model.extend({url:function(){var a=repoPathUrl()+"/resource/acl";return encodeURI(Saiku.session.username+a)},parse:function(a){if(a!="OK"){_.extend(this.attributes,a)}}});var RepositoryZipExport=Backbone.Model.extend({url:function(){var a=repoPathUrl()+"/resource/zip";return encodeURI(Saiku.session.username)+a}});var SavedQuery=Backbone.Model.extend({parse:function(a){},url:function(){var a=encodeURI(Saiku.session.username)+repoPathUrl()+"/resource";return a},move_query_to_workspace:function(g,f){var d=f;var a=g.get("file");for(var j in Settings){if(j.match("^PARAM")=="PARAM"){var e=j.substring("PARAM".length,j.length);var b=new RegExp("\\$\\{"+e+"\\}","g");var h=new RegExp("\\$\\{"+e.toLowerCase()+"\\}","g");d=d.replace(b,Settings[j]);d=d.replace(h,Settings[j])}}var i=new Query({xml:d,formatter:Settings.CELLSET_FORMATTER},{name:a});var c=Saiku.tabs.add(new Workspace({query:i}))}});var Repository=Backbone.Collection.extend({model:SavedQuery,initialize:function(b,a){if(a&&a.dialog){this.dialog=a.dialog}},parse:function(a){if(this.dialog){this.dialog.populate(a)}},url:function(){var a=repoPathUrl()+"?type=saiku";return encodeURI(Saiku.session.username+a)}});var Properties=Backbone.Model.extend({initialize:function(b,a){this.query=a.query;this.properties={};_.extend(this.properties,Settings.QUERY_PROPERTIES);if(typeof b!="undefined"&&b){_.extend(this.properties,b)}},toggle:function(a){this.properties[a]=this.properties[a]==="true"?"false":"true";return this},update:function(a){this.attributes={properties:_.template("<% _.each(properties, function(property, name) { %><%= name %> <%= property %>\n<% }); %>")({properties:this.properties})};this.save({async:a})},parse:function(a){if(typeof a=="object"){_.extend(this.properties,a)}this.query.workspace.trigger("properties:loaded")},url:function(){return encodeURI(this.query.url()+"/properties")}});var Result=Backbone.Model.extend({result:null,firstRun:false,initialize:function(b,a){this.query=a.query},parse:function(a){this.query.workspace.unblock();this.query.workspace.processing.hide();this.result=a;this.firstRun=true;this.query.workspace.trigger("query:result",{workspace:this.query.workspace,data:a})},hasRun:function(){return this.firstRun},lastresult:function(){return this.result},url:function(){return encodeURI(this.query.url()+"/result/"+this.query.get("formatter"))}});var QueryAction=Backbone.Model.extend({initialize:function(b,a){this.query=a.query;this.url=this.query.url},get:function(b,a){this.handle("fetch",b,a)},post:function(b,a){this.handle("save",b,a)},put:function(b,a){this.id=_.uniqueId("queryaction_");this.handle("save",b,a);delete this.id},del:function(b,a){this.id=_.uniqueId("queryaction_");this.handle("delete",b,a);delete this.id},handle:function(c,b,a){this.url=this.query.url()+b;this.attributes=a.data?a.data:{};if(c=="save"){this.save({},a)}else{if(c=="delete"){this.destroy(a)}else{if(c=="fetch"){this.parse=function(){};this.fetch(a)}}}}});var QueryScenario=Backbone.Model.extend({initialize:function(b,a){_.bindAll(this,"attach_listeners","activate","clicked_cell","save_writeback","cancel_writeback","check_input");this.query=a.query},activate:function(){$(this.query.workspace.el).find("td.data").unbind("click").addClass("cellhighlight").click(this.clicked_cell)},attach_listeners:function(a){if(a.workspace.query&&a.workspace.query.properties&&a.workspace.query.properties.properties["org.saiku.connection.scenario"]==="true"&&$(a.workspace.el).find(".query_scenario").hasClass("on")){$(a.workspace.el).find("td.data").click(this.clicked_cell)}},clicked_cell:function(b){var a=$(b.target).hasClass("data")?$(b.target).find("div"):$(b.target);var c=a.attr("alt");var e=a.attr("rel");var d=$("<input type='text' value='"+c+"' />").keyup(this.check_input).blur(this.cancel_writeback);a.html("").append(d);d.focus()},check_input:function(a){if(a.which==13){this.save_writeback(a)}else{if(a.which==27||a.which==9){this.cancel_writeback(a)}}return false},save_writeback:function(a){var c=$(a.target).closest("input");this.set({value:c.val(),position:c.parent().attr("rel")});this.save();var b=c.val();c.parent().text(b)},cancel_writeback:function(a){var b=$(a.target).closest("input");b.parent().text(b.parent().attr("alt"))},parse:function(){this.query.run()},url:function(){return this.query.url()+"/cell/"+this.get("position")+"/"+this.get("value")}});var Query=Backbone.Model.extend({formatter:Settings.CELLSET_FORMATTER,properties:null,initialize:function(b,a){_.extend(this,a);_.bindAll(this,"run","move_dimension","reflect_properties");this.uuid="xxxxxxxx-xxxx-xxxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(f){var e=Math.random()*16|0,d=f=="x"?e:(e&3|8);return d.toString(16)}).toUpperCase();this.action=new QueryAction({},{query:this});this.result=new Result({limit:Settings.RESULT_LIMIT},{query:this});this.scenario=new QueryScenario({},{query:this});this.set({type:"QM"})},parse:function(a){this.id=this.uuid;this.set({connection:a.cube.connectionName,catalog:a.cube.catalogName,schema:a.cube.schemaName,cube:encodeURIComponent(a.cube.name),axes:a.saikuAxes,type:a.type});if(typeof a.properties!="undefined"&&"saiku.ui.formatter" in a.properties){this.set({formatter:a.properties["saiku.ui.formatter"]})}this.properties=new Properties(a.properties,{query:this});this.reflect_properties()},reflect_properties:function(){this.workspace.trigger("properties:loaded")},setProperty:function(a,b){if(typeof this.properties!="undefined"&&this.properties.properties){this.properties.properties[a]=b}},run:function(g,e){Saiku.ui.unblock();if(typeof this.properties!="undefined"&&this.properties.properties["saiku.olap.query.automatic_execution"]==="false"&&!(g===true)){return}this.workspace.unblock();$(this.workspace.el).find(".workspace_results_info").empty();this.workspace.trigger("query:run");this.result.result=null;if(this.get("type")!="MDX"){var f=$(this.workspace.el).find(".rows ul li").size();var a=$(this.workspace.el).find(".columns ul li").size();if((f==0&&a==0)&&!this.workspace.other_dimension){var h=this.get("axes");if(h){for(var c=0;c<h.length;c++){var b=h[c];if(b.name&&b.name=="ROWS"){f=b.dimensionSelections.length}if(b.name&&b.name=="COLUMNS"){a=b.dimensionSelections.length}}}}if(f==0||a==0){$(this.workspace.table.el).html("");$(this.workspace.processing).html('<span class="i18n">You need to put at least one level or measure on Columns and Rows for a valid query.</span>').show();this.workspace.adjust();Saiku.i18n.translate();return}}$(this.workspace.table.el).html("");$(this.workspace.processing).html('<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">Running query...</span> [&nbsp;<a class="cancel i18n" href="#cancel">Cancel</a>&nbsp;]').show();this.workspace.adjust();this.workspace.trigger("query:fetch");Saiku.i18n.translate();var d='<span class="processing_image">&nbsp;&nbsp;</span> <span class="i18n">Running query...</span> [&nbsp;<a class="cancel i18n" href="#cancel">Cancel</a>&nbsp;]';this.workspace.block(d);if(this.get("type")=="MDX"&&e!=null){this.result.save({mdx:e})}else{this.result.fetch()}},move_dimension:function(f,e,d,a){var b=this;$(this.workspace.el).find(".run").removeClass("disabled_toolbar");var c="/axis/"+e+"/dimension/"+f;this.action.post(c,{data:{position:d},dataType:"text",success:function(){if(("MODE" in Settings&&(Settings.MODE=="view"||Settings.MODE=="table"))||(typeof b.properties!="undefined"&&b.properties.properties["saiku.olap.query.automatic_execution"]==="true")){if(!a){b.run(true)}}}})},url:function(){return encodeURI(Saiku.session.username+"/query/"+this.uuid)}});var Session=Backbone.Model.extend({username:null,password:null,sessionid:null,initialize:function(b,a){_.extend(this,Backbone.Events);_.bindAll(this,"check_session","process_session","load_session","login");if(a&&a.username&&a.password){this.username=a.username;this.password=a.password;if(!Settings.DEMO){this.save({username:this.username,password:this.password},{success:this.check_session,error:this.check_session})}else{this.check_session()}}else{this.check_session()}},check_session:function(){if(this.sessionid===null||this.username===null||this.password===null){this.clear();this.fetch({success:this.process_session})}else{this.username=encodeURIComponent(options.username);this.load_session()}},load_session:function(){this.sessionworkspace=new SessionWorkspace()},process_session:function(b,a){if((a===null||a.sessionid==null)){Saiku.ui.unblock();if(Settings.DEMO){this.form=new DemoLoginForm({session:this})}else{this.form=new LoginForm({session:this})}this.form.render().open()}else{this.sessionid=a.sessionid;this.roles=a.roles;this.username=encodeURIComponent(a.username);this.language=a.language;if(typeof this.language!="undefined"&&this.language!=Saiku.i18n.locale){Saiku.i18n.locale=this.language;Saiku.i18n.automatic_i18n()}this.load_session()}return this},error:function(){$(this.form.el).dialog("open")},login:function(c,b){var a=(new Date()).getTime()+Settings.LOCALSTORAGE_EXPIRATION;typeof localStorage!=="undefined"&&localStorage&&localStorage.setItem("expiration",a);this.save({username:c,password:b},{dataType:"text",success:this.check_session,error:this.check_session})},logout:function(){Saiku.ui.unblock();$("#header").empty().hide();$("#tab_panel").remove();Saiku.tabs=new TabSet();Saiku.toolbar.remove();Saiku.toolbar=new Toolbar();typeof localStorage!=="undefined"&&localStorage&&localStorage.clear();this.id=_.uniqueId("queryaction_");this.clear();this.sessionid=null;this.username=null;this.password=null;this.destroy({async:false});document.location.reload(false);delete this.id},url:function(){return"session"}});var SessionWorkspace=Backbone.Model.extend({initialize:function(b,a){_.extend(this,Backbone.Events);_.bindAll(this,"process_datasources","prefetch_dimensions");this.initialized=false;this.first=true;if(typeof localStorage!=="undefined"&&localStorage){if(localStorage.getItem("expiration")&&!(localStorage.getItem("expiration")>(new Date()).getTime())){localStorage.clear()}else{if(!localStorage.getItem("saiku-version")||(localStorage.getItem("saiku-version")!==Settings.VERSION)){localStorage.clear()}}}Saiku.ui.block("Loading datasources....");this.fetch({success:this.process_datasources},{})},refresh:function(){typeof localStorage!=="undefined"&&localStorage&&localStorage.clear();this.clear();localStorage.setItem("saiku-version",Settings.VERSION);this.fetch({success:this.process_datasources},{})},destroy:function(){typeof localStorage!=="undefined"&&localStorage&&localStorage.clear();return false},process_datasources:function(b,a){if(typeof localStorage!=="undefined"&&localStorage&&localStorage.getItem("session")===null){localStorage.setItem("session",JSON.stringify(a))}this.cube_navigation=_.template($("#template-cubes").html())({connections:a});this.cube={};this.connections=a;_.delay(this.prefetch_dimensions,20);if(!this.initialized){$(Saiku.toolbar.el).prependTo($("#header"));$("#header").show();Saiku.ui.unblock();Saiku.tabs.render();if(!Settings.INITIAL_QUERY){Saiku.tabs.add(new Workspace())}Saiku.events.trigger("session:new",{session:this})}else{if(!Settings.INITIAL_QUERY){Saiku.tabs.add(new Workspace())}}},prefetch_dimensions:function(){for(var g=0;g<this.connections.length;g++){var a=this.connections[g];for(var f=0;f<a.catalogs.length;f++){var h=a.catalogs[f];for(var e=0;e<h.schemas.length;e++){var d=h.schemas[e];for(var c=0;c<d.cubes.length;c++){var b=d.cubes[c];var m=a.name+"/"+h.name+"/"+((d.name==""||d.name==null)?"null":d.name)+"/"+encodeURIComponent(b.name);if(typeof localStorage!=="undefined"&&localStorage&&localStorage.getItem("cube."+m)!==null){this.cube[m]=new Cube(JSON.parse(localStorage.getItem("cube."+m)))}else{this.cube[m]=new Cube({key:m});if(Settings.DIMENSION_PREFETCH===true){this.cube[m].fetch()}}}}}}if(!this.initialized&&Backbone.history){Backbone.history.start();this.initialized=true}},url:function(){if(this.first){this.first=false;return encodeURI(Saiku.session.username+"/discover")}else{return encodeURI(Saiku.session.username+"/discover/refresh")}}});var Member=Backbone.Model.extend({initialize:function(b,a){this.cube=a.cube;var c=a.dimension.split("/");this.dimension=c[0];this.hierarchy=c[2];this.level=c[3]},url:function(){var a=encodeURI(Saiku.session.username+"/discover/")+this.cube+encodeURI("/dimensions/"+this.dimension+"/hierarchies/"+this.hierarchy+"/levels/"+this.level);return a}});var Saiku={toolbar:{},tabs:new TabSet(),session:null,events:_.extend({},Backbone.Events),routers:[],ui:{block:function(a){$(".processing_message").html(a);$(".processing_message").removeClass("i18n_translated").addClass("i18n");Saiku.i18n.translate();$(".processing,.processing_container").show()},unblock:function(){$(".processing,.processing_container, .blockOverlay").hide();$(".blockUI").fadeOut("slow")}}};Backbone.emulateHTTP=false;if(!Settings.BIPLUGIN){$(document).ready(function(){Saiku.session=new Session({},{username:Settings.USERNAME,password:Settings.PASSWORD});Saiku.toolbar=new Toolbar()})};(function(d){var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",c=String.fromCharCode,b=(function(){try{document.createElement("$")}catch(e){return e}}());d.Base64||(d.Base64={encode:function(f){var p,n,o,m,k,h,j,e=0,g=f.length,l=Math.max,q="";while(e<g){p=f.charCodeAt(e++)||0;n=f.charCodeAt(e++)||0;j=f.charCodeAt(e++)||0;if(l(p,n,j)>255){throw b}o=(p>>2)&63;m=((p&3)<<4)|((n>>4)&15);k=((n&15)<<2)|((j>>6)&3);h=j&63;if(!n){k=h=64}else{if(!j){h=64}}q+=a.charAt(o)+a.charAt(m)+a.charAt(k)+a.charAt(h)}return q}})}(this));Backbone.sync=function(a,h,n){var f;methodMap={create:"POST",read:"GET",update:"PUT","delete":"DELETE"};var i=methodMap[a];var c=Settings.REST_URL+(_.isFunction(h.url)?h.url():h.url);if(typeof Settings.ERRORS=="undefined"){Settings.ERRORS=0}var k=function(){Settings.ERRORS++;if(Settings.ERRORS<Settings.ERROR_TOLERANCE){Saiku.session.logout()}else{Saiku.ui.block("Communication problem with the server. Please reload the application...")}};var b={0:function(){k()},401:function(){k()}};var d=function(o,q,p){if(!isIE&&typeof console!="undefined"&&console&&console.error){console.error("Error performing "+i+" on "+c);console.error(p)}if(n.error){n.error(o,q,p)}};var m=function(p,q,o){Settings.ERRORS=0;Saiku.ui.unblock();n.success(p,q,o)};var e=true;if(n.async===false){e=false}var j="json";if(typeof n.dataType!="undefined"){j=n.dataType}var l="application/x-www-form-urlencoded";if(typeof n.contentType!="undefined"){l=n.contentType}var g=h.attributes;if(typeof n.data!="undefined"){g=n.data}f={url:c,type:i,cache:false,data:g,contentType:l,dataType:j,success:m,statusCode:b,error:d,async:e};if((Settings.BIPLUGIN&&!Settings.BIPLUGIN5)||Backbone.emulateHTTP){if(i==="PUT"||i==="DELETE"){if(Backbone.emulateHTTP){f.data._method=i}f.type="POST";f.beforeSend=function(o){o.setRequestHeader("X-HTTP-Method-Override",i)}}}$.ajax(f)};var QueryRouter=Backbone.Router.extend({routes:{"query/open/*query_name":"open_query","query/open":"open_query_repository"},open_query:function(b){Settings.ACTION="OPEN_QUERY";var c={};var a="text";if(!Settings.BIPLUGIN5&&Settings.BIPLUGIN){var e=(Settings.GET.SOLUTION?(Settings.GET.SOLUTION+"/"):"")+(Settings.GET.PATH&&Settings.GET.PATH!="/"?(Settings.GET.PATH+"/"):"")+(Settings.GET.ACTION||"");c={file:e}}else{c={file:b}}var g=_.extend({file:c.file},Settings.PARAMS);var d={populate:function(h){if(h&&h.length>0){var j=h[0];var i=new Query(g,{name:c.file});Saiku.tabs.add(new Workspace({query:i,item:h[0]}))}else{Saiku.tabs.add(new Workspace())}Settings.INITIAL_QUERY=false}};var f=new Repository({},{dialog:d}).fetch({async:false,data:{path:c.file}})},open_query_repository:function(){Toolbar.prototype.open_query()}});Saiku.routers.push(new QueryRouter());var Statistics=Backbone.View.extend({data:{resultset:[],metadata:[]},initialize:function(a){this.workspace=a.workspace;this.id=_.uniqueId("stats_");$(this.el).attr({id:this.id});_.bindAll(this,"render","receive_data","process_data","show","setOptions");this.workspace.bind("query:result",this.receive_data);this.add_button();this.workspace.querytoolbar.stats=this.show;$(this.workspace.el).find(".workspace_results").prepend($(this.el).hide())},add_button:function(){var a=$('<a href="#stats" class="stats button disabled_toolbar i18n" title="Basic Statistics"></a>').css({"background-image":"url('js/saiku/plugins/Statistics/sigma.png')","background-repeat":"no-repeat","background-position":"50% 50%",height:"32px","margin-top":"5px"});var b=$('<li class="seperator_vertical"></li>').append(a);$(this.workspace.querytoolbar.el).find("ul.table").append(b)},show:function(a,b){$(this.workspace.el).find(".workspace_results table").toggle();$(this.el).toggle();$(a.target).toggleClass("on");if($(a.target).hasClass("on")){this.process_data({data:this.workspace.query.result.lastresult()})}else{this.workspace.table.render({data:this.workspace.query.result.lastresult()})}},setOptions:function(b){var a=$(b.target).attr("href").replace("#","");try{this[a]()}catch(c){}return false},render:function(){if(!$(this.workspace.querytoolbar.el).find(".stats").hasClass("on")||($(this.workspace.el).is(":visible")&&!$(this.el).is(":visible"))){return}var i=function(p,t){var s="<tr>";var r=t?"<th class='row_header'>":"<th class='row'>";var q=t?"<th class='col'>":"<td class='data'>";var o=t?"</th>":"</td>";_.each(p,function(v,u){s+=((u==0)?r:q)+"<div "+((u==0)?'class="i18n"':"")+">"+v+"</div>"+o});s+="</tr>";return s};var m=function(p,q,o){var r=_.filter(_.map(p,function(s){return s[q]}),function(s){return s});return o(r).toFixed(3)};var j=function(o){return _.reduce(o,function(p,q){return p+q},0)};var b=function(o){return(j(o))/o.length};var d=function(p){var o=b(p);return Math.sqrt(j(_.map(p,function(q){return Math.pow(o-q,2)}))/p.length)};var h=function(o){return _.min(o)};var l=function(o){return _.max(o)};$(this.el).empty();var a=this.data.metadata;var f=this.data.resultset;var c=_.filter(a,function(o){return !o.isHeader&&o.colType=="Numeric"});var e=_.map(c,function(o){return o.colName});var k=_.map(e,function(o){return _.indexOf(_.map(a,function(p){return p.colName}),o)});var n=$("<table style='display: table; '>");var g=$("<tbody>").appendTo(n);g.append(i(["Statistics"].concat(e),true));g.append(i(["Min"].concat(_.map(k,function(o){return m(f,o,h)})),false));g.append(i(["Max"].concat(_.map(k,function(o){return m(f,o,l)})),false));g.append(i(["Sum"].concat(_.map(k,function(o){return m(f,o,j)})),false));g.append(i(["Average"].concat(_.map(k,function(o){return m(f,o,b)})),false));g.append(i(["Std. Deviation"].concat(_.map(k,function(o){return m(f,o,d)})),false));$(this.el).append(n);Saiku.i18n.translate()},receive_data:function(a){return _.delay(this.process_data,0,a)},process_data:function(d){this.data={};this.data.resultset=[];this.data.metadata=[];this.data.height=0;this.data.width=0;if(typeof d=="undefined"||typeof d.data=="undefined"||!$(this.el).is(":visible")){return}if(d.data!=null&&d.data.error!=null){$(this.el).empty()}if(d.data==null||(d.data.cellset&&d.data.cellset.length===0)){$(this.el).empty()}if(d.data&&d.data.cellset&&d.data.cellset.length>0){var e=0;var b=true;var f=new Array();for(var i=0;i<d.data.cellset.length;i++){if(b&&(d.data.cellset[i][0].type=="ROW_HEADER_HEADER"||d.data.cellset[i][0].value=="null")){this.data.metadata=[];for(var g=0;g<d.data.cellset[i].length;g++){if(d.data.cellset[i][g].type=="ROW_HEADER_HEADER"){this.data.metadata.shift();e=g}if(f[g]){f[g].push(d.data.cellset[i][g].value)}else{f[g]=[d.data.cellset[i][g].value]}if(d.data.cellset[i][0].type=="ROW_HEADER_HEADER"){this.data.metadata.push({colIndex:g,colType:typeof(d.data.cellset[i+1][g].value)!=="number"&&isNaN(d.data.cellset[i+1][g].value.replace(/[^a-zA-Z 0-9.]+/g,""))?"String":"Numeric",colName:f[g].join(" / "),isHeader:(d.data.cellset[i][g].type=="ROW_HEADER_HEADER")})}}}else{if(d.data.cellset[i][e].value!=="null"&&d.data.cellset[i][e].value!==""){b=false;var c=[];this.data.width=d.data.cellset[i].length;for(var a=e;a<d.data.cellset[i].length;a++){var h=d.data.cellset[i][a].value;if(d.data.cellset[i][a].properties.raw&&d.data.cellset[i][a].properties.raw!=="null"){h=parseFloat(d.data.cellset[i][a].properties.raw)}else{if(typeof(d.data.cellset[i][a].value)!=="number"&&parseFloat(d.data.cellset[i][a].value.replace(/[^a-zA-Z 0-9.]+/g,""))){h=parseFloat(d.data.cellset[i][a].value.replace(/[^a-zA-Z 0-9.]+/g,""))}}if(a==e){h+=" ["+i+"]"}c.push(h)}this.data.resultset.push(c)}}}this.data.height=this.data.resultset.length;this.workspace.processing.hide();this.render()}else{$(this.el).empty();this.no_results()}},no_results:function(a){$(this.el).text("No results")},error:function(a){$(this.el).text(safe_tags_replace(a.data.error))}});Saiku.events.bind("session:new",function(d){function b(f){if(typeof f.workspace.stats=="undefined"){f.workspace.stats=new Statistics({workspace:f.workspace})}}function e(f){if(typeof f.workspace.stats!="undefined"&&$(f.workspace.stats.el).is(":visible")){$(f.workspace.stats.el).parents().find(".workspace_results table").show();$(f.workspace.stats.el).hide();f.workspace.stats.data={};f.workspace.stats.data.resultset=[];f.workspace.stats.data.metadata=[];f.workspace.stats.data.height=0;f.workspace.stats.data.width=0}}for(var a=0;a<Saiku.tabs._tabs.length;a++){var c=Saiku.tabs._tabs[a];b({workspace:c.content})}Saiku.session.bind("workspace:new",b);Saiku.session.bind("workspace:clear",e)});Saiku.i18n={locale:(navigator.language||navigator.browserLanguage||navigator.systemLanguage||navigator.userLanguage).substring(0,2).toLowerCase(),po_file:{},translate:function(){$(".i18n").i18n(Saiku.i18n.po_file)},automatic_i18n:function(){if(Saiku.i18n.locale=="zh"){Saiku.i18n.locale="cn"}if(Saiku.i18n.locale!="en"){$.ajax({url:"js/saiku/plugins/I18n/po/"+Saiku.i18n.locale+".json",type:"GET",dataType:"json",success:function(a){Saiku.i18n.po_file=a;Saiku.i18n.translate()}})}return true},elements:[],improve_translation:function(){Saiku.tabs.add(new TranslationTab());return false}};(function(a){a.fn.i18n=function(b){if(!b){return this}var c=function(e,d){if(typeof d[e]=="undefined"){return""}else{return d[e]}};return a.each(this,function(){element=a(this);if(element.html()){translated_text=c(element.html(),b);if(Saiku.i18n.elements.indexOf&&Saiku.i18n.elements.indexOf(element.html())===-1){Saiku.i18n.elements.push(element.html())}if(translated_text){element.data("original",element.html());element.html(translated_text);element.removeClass("i18n")}}if(element.attr("title")){translated_title=c(element.attr("title"),b);if(Saiku.i18n.elements.indexOf&&Saiku.i18n.elements.indexOf(element.attr("title"))===-1){Saiku.i18n.elements.push(element.attr("title"))}if(translated_title){element.data("original",element.attr("title"));element.attr({title:translated_title});element.removeClass("i18n")}}if(element.hasClass("i18n")){element.addClass("i18n_failed")}element.addClass("i18n_translated")})};a.fn.un_i18n=function(){return a.each(this,function(){element=a(this);if(element.text()){element.text(element.data("original"))}if(element.attr("title")){element.attr({title:element.data("original")})}element.addClass("i18n");element.removeClass("i18n_translated").removeClass("i18n_failed")})}})(jQuery);var TranslationTab=Backbone.View.extend({className:"workspace_area",caption:function(){return Saiku.i18n.po_file["Improve this translation"]?Saiku.i18n.po_file["Improve this translation"]:"Improve this translation"},events:{"submit form":"submit","change input":"mark"},initialize:function(){$(window).resize(this.adjust);$(this.el).focus(this.adjust);this.adjust()},render:function(){var c={};for(var a=0;a<Saiku.i18n.elements.length;a++){c[Saiku.i18n.elements[a]]={value:Saiku.i18n.po_file[Saiku.i18n.elements[a]],name:encodeURI(Saiku.i18n.elements[a])}}var b=_.template("<form class='workspace_results'>Your name: <input type='text' name='translator_name' /><p>Please fill in the appropriate translation in the blanks provided:<p><% _.each(translation_table, function(val, key) { %><div><b><%= key %></b><br /><input type='text' value='<%= val.value %>' name='<%= val.name %>' /></div><% }); %><div><input class='submit-translation' type='submit' value='Submit translation' /></div></form>")({translation_table:c});$(this.el).html(b).find("div").css({"float":"left",padding:"20px"}).find("input").css({width:"300px"});$(this.el).find(".submit-translation").css({padding:"20px"})},mark:function(a){$(a.target).addClass("changed")},submit:function(){var a={locale:Saiku.i18n.locale};$(this.el).find(".changed").each(function(b){a[decodeURI($(this).attr("name"))]=encodeURI($(this).val())});window.location="mailto:contact@analytical-labs.com?subject=Translation for "+Saiku.i18n.locale+"&body="+JSON.stringify(a);Saiku.ui.block("Thank you for improving our translation!");this.tab.remove();_.delay(function(){Saiku.ui.unblock()},1000);return false},adjust:function(){$(this.el).height($("body").height()-87)}});Saiku.i18n.automatic_i18n();Saiku.events.bind("session:new",function(){Saiku.i18n.translate();Saiku.session.bind("tab:add",Saiku.i18n.translate);if(Saiku.i18n.locale!="en"){var a=$("<a />").text(Saiku.i18n.locale).attr({href:"#translate",title:"Improve this translation"}).click(Saiku.i18n.improve_translation).addClass("sprite translate i18n");var b=$("<li />").append(a);$(Saiku.toolbar.el).find("ul").append(b)}});if(window.logger){window.Translate=new logger({url:Settings.TELEMETRY_SERVER+"/input/translations"})};var puc={allowSave:function(a){if(window.parent.mantle_initialized!==undefined&&window.parent.mantle_initialized&&window.parent.enableAdhocSave){if(window.ALLOW_PUC_SAVE===undefined||ALLOW_PUC_SAVE){window.parent.enableAdhocSave(a)}}},refresh_repo:function(){if(window.parent.mantle_initialized!==undefined&&window.parent.mantle_initialized){window.parent.mantle_refreshRepository()}},save_to_solution:function(b,a,f,d,c){var e=Saiku.tabs._tabs[0].content.query;e.action.get("/xml",{success:function(h,g){b=b&&b.length>".saiku".length&&b.substring(b.length-".saiku".length,b.length)==".saiku"?b:b+".saiku";var i=(a?(a+"/"):"")+(f?(f+"/"):"")+(b||"");(new SavedQuery({name:b,file:i,content:g.xml})).save({success:function(){puc.refresh_repo()}})}})}};var RepositoryBrowserControllerProxy=function(){this.remoteSave=puc.save_to_solution};var Wiz=function(){this.currPgNum=0};var WaqrProxy=function(){this.wiz=new Wiz();this.repositoryBrowserController=new RepositoryBrowserControllerProxy()};var gCtrlr=new WaqrProxy();var savePg0=function(){};if(Settings.BIPLUGIN){Settings.PLUGIN=true;Settings.REST_URL="../saiku/";if(Settings.BIPLUGIN5){Settings.REST_URL="../../plugin/saiku/api/"}$(document).ready(function(){Saiku.session=new Session();$.getScript(Settings.REST_URL+Saiku.session.username+"/plugin/plugins")})}var BIPlugin={bind_callbacks:function(a){$(a.toolbar.el).find(".run").parent().removeClass("seperator");a.bind("query:result",function(c){var b=c.data.cellset&&c.data.cellset.length>0;puc.allowSave(b)})}};Saiku.events.bind("session:new",function(a){if(Settings.PLUGIN){$("#header").remove();if(Saiku.tabs._tabs[0]&&Saiku.tabs._tabs[0].content){BIPlugin.bind_callbacks(Saiku.tabs._tabs[0].content)}Saiku.session.bind("workspace:new",function(b){BIPlugin.bind_callbacks(b.workspace)})}});var Datasources=Backbone.Model.extend({list:[],initialize:function(b,a){_.extend(this,Backbone.Events)},parse:function(a){this.set({list:a});return a},url:function(){return(Saiku.session.username+"/datasources")}});if(Settings.PLUGIN){window.parent.getSaikuMdx=function(){var a=this;var b=Saiku.tabs._tabs[0].content.query;b.clear();b.fetch({success:function(d,c){var e=new Datasources();e.fetch({success:function(k,f){for(var j=0;j<f.length;j++){if(f[j].name==c.cube.connectionName){var m=f[j].properties.location.split(";");var l="";var g="";$.each(m,function(i,n){var o=n.split("=");if(o[0]=="DataSource"){l=o[1]}if(o[0]=="Catalog"){g=o[1]}});var h={connection:f[j].name,catalog:g,jndi:l,mdx:c.mdx};window.parent.saveSaiku(h)}}}})}})}};var Buckets=Backbone.View.extend({events:{"click .add_bucket":"add_bucket","click  a.save":"save_bucket","click .bucket":"click_bucket","click .delete":"delete_bucket"},bucket_css:{color:"#555","margin-right":"5px","text-decoration":"none",border:"1px solid #ccc",padding:"5px","-moz-border-radius":"3px","-webkit-border-radius":"3px"},tags:[],tags_template:function(){var a=this;var b="<div class='bucket_items'><ul><li><a href='#' class='add_bucket i18n button' title='Add new tag by selecting cells from your result!'> </a></li>";_.each(this.tags,function(c){b+=a.tag_template(c)});b+="</div>";return b},tag_template:function(a){var b=a.name+": ";_.each(a.saikuTuples,function(c){var d=true;b+=" (";_.each(c.saikuMembers,function(e){if(!d){b+=",  "}d=false;b+=e.uniqueName});b+=")"});return"<li class='seperator'><a href='#"+a.name+"' title='"+b+"' class='bucket button'>"+a.name+"</a></li><li style='padding-left:0px'><a class='delete' href='#"+a.name+"'>x</a></li>"},initialize:function(a){this.workspace=a.workspace;this.id=_.uniqueId("buckets_");$(this.el).attr({id:this.id});_.bindAll(this,"render","show","buildTemplate","render","deactivate_add_bucket","add_bucket","save_bucket","click_bucket");this.add_button();this.workspace.toolbar.buckets=this.show;this.workspace.bind("workspace:adjust",this.render);$(this.workspace.el).find(".workspace_results").prepend($(this.el).hide())},add_button:function(){var a=$('<a href="#buckets" class="buckets button disabled_toolbar i18n" title="Tags"></a>').css({"background-image":"url('js/saiku/plugins/Buckets/tag_red.png')","background-repeat":"no-repeat","background-position":"50% 50%"});var b=$('<li class="seperator"></li>').append(a);$(this.workspace.toolbar.el).find("ul").append(b)},show:function(d,e){var b=this;$(this.el).toggle();$(d.target).toggleClass("on");if($(d.target).hasClass("on")){if($(b.workspace.toolbar.el).find(".zoom_mode.on").length>0){$(b.workspace.toolbar.el).find(".zoom_mode.on").click()}var c=b.workspace.query.get("schema");var a=b.workspace.query.get("connection")+"-"+b.workspace.query.get("catalog")+"-"+((c==""||c==null)?"null":c)+"-"+b.workspace.query.get("cube");this.repo=new TagRepository({cube:a}).fetch({success:this.buildTemplate})}else{this.workspace.query.action.del("/tag",{success:this.workspace.query.run})}},buildTemplate:function(b,a){this.tags=a;this.render()},render:function(){if(!$(this.workspace.toolbar.el).find(".buckets").hasClass("on")){return}$(this.el).empty();var b=this.tags_template();var a=$(b);$(this.el).append(a)},deactivate_add_bucket:function(){var a=this;var b=$(a.el).find(".add_bucket");b.removeClass("on");$(a.el).find(".new_bucket").parent().remove();return},add_bucket:function(c){var a=this;var d=$(a.el).find(".add_bucket");if(d.hasClass("on")){a.deactivate_add_bucket();return}d.addClass("on");$("<li><input id='new_bucket' type='text' class='new_bucket'/></li><li><a href='#save_bucket' class='i18n save sprite button new_bucket' title='Save Tag'></a></li>").insertAfter($(a.el).find(".bucket_items .add_bucket").parent());var b=function(e){$target=$(e.target).hasClass("data")?$(e.target).find("div"):$(e.target);if($target.parent().hasClass("selected")){$target.parent().removeClass("selected")}else{$target.parent().addClass("selected")}};$(a.workspace.el).find("td.data").addClass("cellhighlight").unbind("click").click(b);$(a.workspace.el).find(".query_scenario, .drillthrough, .drillthrough_export").removeClass("on")},save_bucket:function(){var e=this;var b=$(e.workspace.el).find("td.selected div");if(b.size()<1){alert("You need to select at least 1 cell for tagging before you can save!");return}var c="";$.each(b,function(h,i){if(h>0){c+=","}c+=$(i).attr("rel")});$(e.workspace.el).find("td.data").removeClass("cellhighlight").unbind("click");$(e.workspace.el).find("td.selected").removeClass("selected");var g=$(e.el).find("#new_bucket").val();var d=function(i,h){e.tags.push(i);e.deactivate_add_bucket();$tag=$(e.tag_template(i)).appendTo($(e.el).find(".bucket_items ul"))};var f=e.workspace.query.get("schema");var a=e.workspace.query.get("connection")+"-"+e.workspace.query.get("catalog")+"-"+((f==""||f==null)?"null":f)+"-"+e.workspace.query.get("cube");(new SaikuTag({positions:c,name:g,cube:a,queryname:e.workspace.query.id},{success:d})).save()},click_bucket:function(c){var b=$(c.target).attr("href").replace("#","");var a=this;if($(c.target).hasClass("on")){$(c.target).removeClass("on");this.workspace.query.action.del("/tag",{success:this.workspace.query.run})}else{$(c.target).addClass("on");_.each(this.tags,function(d){if(d.name==b){a.workspace.query.action.put("/tag",{success:a.workspace.query.run,data:{tag:JSON.stringify(d)}})}})}$(c.target).parent().siblings().find(".on").removeClass("on")},delete_bucket:function(d){var e=$(d.target).attr("href").replace("#","");var b=this;var f=function(){alert("y")};var c=b.workspace.query.get("schema");var a=b.workspace.query.get("connection")+"-"+b.workspace.query.get("catalog")+"-"+((c==""||c==null)?"null":c)+"-"+b.workspace.query.get("cube");(new SaikuTag({name:e,id:"dummy",cube:a},{})).destroy();$(d.target).parent().prev().remove();$(d.target).parent().remove()}});Saiku.events.bind("session:new",function(d){function b(f){if(typeof f.workspace.buckets=="undefined"){f.workspace.buckets=new Buckets({workspace:f.workspace});f.workspace.bind("query:result",f.workspace.buckets.deactivate_add_bucket)}}function e(f){if(typeof f.workspace.buckets!="undefined"){$(f.workspace.buckets.el).hide()}}for(var a=0;a<Saiku.tabs._tabs.length;a++){var c=Saiku.tabs._tabs[a];b({workspace:c.content})}Saiku.session.bind("workspace:new",b);Saiku.session.bind("workspace:clear",e)});var SaikuTag=Backbone.Model.extend({initialize:function(b,a){_.extend(this.attributes,b);if(a!=null&&a.success){this.parse=a.success}},url:function(){return encodeURI(Saiku.session.username+"/tags/"+this.get("cube")+"/"+this.get("name"))}});var TagRepository=Backbone.Collection.extend({model:SaikuTag,initialize:function(b,a){this.cube=b.cube},url:function(){return encodeURI(Saiku.session.username+"/tags/"+this.cube)}});var Chart=Backbone.View.extend({initialize:function(b){this.workspace=b.workspace;this.id=_.uniqueId("chart_");$(this.el).attr({id:this.id});this.renderer=new SaikuChartRenderer(null,{htmlObject:$(this.el),zoom:true,adjustSizeTo:".workspace_results"});_.bindAll(this,"receive_data","show","render_view","exportChart");var a=this;this.workspace.bind("query:run",function(){if(!$(a.workspace.querytoolbar.el).find(".render_chart").hasClass("on")){return false}a.renderer.data={};a.renderer.data.resultset=[];a.renderer.data.metadata=[];$(a.el).find(".canvas_wrapper").hide();return false});this.workspace.bind("query:result",this.receive_data);var c="<div id='nav"+this.id+"' style='display:none' class='nav'><form id='svgChartPseudoForm' target='_blank' method='POST'><input type='hidden' name='type' class='type'/><input type='hidden' name='svg' class='svg'/></form></div>";if(isIE){c="<div></div>"}this.nav=$(c);$(this.el).append(this.nav)},exportChart:function(a){var d=new XMLSerializer().serializeToString($("svg")[0]);var c='<svg xmlns="http://www.w3.org/2000/svg" ';if(d.substr(0,c.length)!=c){d=d.replace("<svg ",c)}var b=$("#svgChartPseudoForm");b.find(".type").val(a);b.find(".svg").val(d);b.attr("action",Settings.REST_URL+this.workspace.query.url()+escape("/../../export/saiku/chart"));b.submit();return false},render_view:function(){$(this.workspace.el).find(".workspace_results").prepend($(this.el).hide())},show:function(a,c){this.workspace.adjust();this.renderer.cccOptions.width=$(this.workspace.el).find(".workspace_results").width()-40;this.renderer.cccOptions.height=$(this.workspace.el).find(".workspace_results").height()-40;$(this.el).show();var b=this.workspace.query.result.hasRun();if(b){this.renderer.process_data_tree({data:this.workspace.query.result.lastresult()},true,true);this.renderer.switch_chart(this.renderer.type)}},export_button:function(c){var b=this;var a=$(c.target).hasClass("button")?$(c.target):$(c.target).parent();var b=this;var d=$(document);$.contextMenu("destroy",".export_button");$.contextMenu({selector:".export_button",trigger:"left",ignoreRightClick:true,callback:function(f,e){b.workspace.chart.exportChart(f)},items:{png:{name:"PNG"},jpg:{name:"JPEG"},pdf:{name:"PDF"},svg:{name:"SVG"}}});a.contextMenu()},receive_data:function(a){if(!$(this.workspace.querytoolbar.el).find(".render_chart").hasClass("on")){return}this.workspace.adjust();this.renderer.process_data_tree(a,true,true);this.renderer.switch_chart(this.renderer.type)}});